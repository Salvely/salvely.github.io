<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>CSAPP Chapter 4 - 处理器体系结构 - Wen Gao 的小站</title><meta name=Description content="Wen Gao 的个人博客"><meta property="og:url" content="https://salvely.github.io/ch4/">
<meta property="og:site_name" content="Wen Gao 的小站"><meta property="og:title" content="CSAPP Chapter 4 - 处理器体系结构"><meta property="og:description" content="Wen Gao 的个人博客"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-13T09:59:48+00:00"><meta property="article:modified_time" content="2025-03-21T19:12:48+08:00"><meta property="og:image" content="https://salvely.github.io/images/avatar.webp"><meta property="og:see_also" content="https://salvely.github.io/ch5/"><meta property="og:see_also" content="https://salvely.github.io/arch-lab%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/"><meta property="og:see_also" content="https://salvely.github.io/attack-lab-recitation/"><meta property="og:see_also" content="https://salvely.github.io/bomb-lab-recitation/"><meta property="og:see_also" content="https://salvely.github.io/machine-procedures-activity/"><meta property="og:see_also" content="https://salvely.github.io/machine-data-activity/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://salvely.github.io/images/avatar.webp"><meta name=twitter:title content="CSAPP Chapter 4 - 处理器体系结构"><meta name=twitter:description content="Wen Gao 的个人博客"><meta name=application-name content="DoIt"><meta name=apple-mobile-web-app-title content="DoIt"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://salvely.github.io/ch4/><link rel=prev href=https://salvely.github.io/attack-lab-recitation/><link rel=next href=https://salvely.github.io/arch-lab%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/><link rel=stylesheet href=/css/main.min.css><link rel=stylesheet href=/css/style.min.css><meta name=google-site-verification content="UJapM2d84iH6w1FVXFWeXhz_PoqtMDTU3mmNjGfRe1E"><meta name=msvalidate.01 content="C974411E5F5A79173F7830327E92F59E"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CSAPP Chapter 4 - 处理器体系结构","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https://salvely.github.io/ch4/"},"image":["https://salvely.github.io/images/Apple-Devices-Preview.png"],"genre":"posts","wordcount":15037,"url":"https://salvely.github.io/ch4/","datePublished":"2024-03-13T09:59:48+00:00","dateModified":"2025-03-21T19:12:48+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https://salvely.github.io/images/Salvely.jpg","width":400,"height":400}},"author":[{"@type":"Person","name":"Wen Gao","url":"https://github.com/Salvely"}],"description":""}</script></head><body data-instant-intensity=viewport><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.className=e,document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),e==="light"?document.documentElement.classList.remove("tw-dark"):document.documentElement.classList.add("tw-dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#161b22"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><header class="desktop print:!tw-hidden" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Wen Gao 的小站"><span class=tw-mr-1><svg class="icon" viewBox="0 0 576 512"><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1.0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7.0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174 402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7-43.2-43.2c-4.1-4.1-10.8-4.1-14.8.0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg></span>Wen Gao 的小站</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/series/>系列 </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=/task/%E4%BB%BB%E5%8A%A1%E5%88%97%E8%A1%A8/>任务列表 </a><a class=menu-item href=/roadmap/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E4%B9%8B%E8%B7%AF/>计算机科学之路 </a><a class=menu-item href=/series/%E8%AE%B0%E5%BD%95/>周记 </a><a class=menu-item href=https://github.com/Salvely/salvely.github.io title=GitHub rel="noopener noreferrer" target=_blank><svg class="icon" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<button class="search-button search-toggle" id=search-toggle-desktop title=搜索>
<svg class="icon" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</button>
<button class="search-button search-clear" id=search-clear-desktop title=清空>
<svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3.0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3.0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3.0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3.0 17L312 256l65.6 65.1z"/></svg>
</button>
<span class="search-button search-loading tw-animate-spin" id=search-loading-desktop><svg class="icon" viewBox="0 0 512 512"><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49.0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156.0c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"/></svg>
</span></span><button class="menu-item theme-select" aria-label=切换主题>
<svg class="icon" viewBox="0 0 512 512"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg>
<select class=color-theme-select id=theme-select-desktop aria-label=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=auto>跟随系统</option></select></button></div></div></div></header><header class="mobile print:!tw-hidden" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Wen Gao 的小站"><span class=tw-mr-1><svg class="icon" viewBox="0 0 576 512"><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1.0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7.0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174 402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7-43.2-43.2c-4.1-4.1-10.8-4.1-14.8.0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg></span>Wen Gao 的小站</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<button class="search-button search-toggle tw-h-10" id=search-toggle-mobile title=搜索>
<svg class="icon" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</button>
<button class="search-button search-clear tw-h-fit" id=search-clear-mobile title=清空>
<svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3.0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3.0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3.0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3.0 17L312 256l65.6 65.1z"/></svg>
</button>
<span class="search-button search-loading tw-animate-spin" id=search-loading-mobile><svg class="icon" viewBox="0 0 512 512"><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49.0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156.0c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"/></svg></span></div><button class=search-cancel id=search-cancel-mobile>
取消</button></div><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/series/ title>系列</a><a class=menu-item href=/about/ title>关于</a><a class=menu-item href=/task/%E4%BB%BB%E5%8A%A1%E5%88%97%E8%A1%A8/ title>任务列表</a><a class=menu-item href=/roadmap/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E4%B9%8B%E8%B7%AF/ title>计算机科学之路</a><a class=menu-item href=/series/%E8%AE%B0%E5%BD%95/ title>周记</a><a class=menu-item href=https://github.com/Salvely/salvely.github.io title=GitHub rel="noopener noreferrer" target=_blank><svg class="icon" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></a><button class="menu-item theme-select tw-w-full" aria-label=切换主题>
<svg class="icon" viewBox="0 0 512 512"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg>
<select class=color-theme-select id=theme-select-mobile aria-label=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=auto>跟随系统</option></select></button></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=tw-mx-4><div class="toc print:!tw-hidden" id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#y86_64-指令集架构>Y86_64 指令集架构</a><ul><li><a href=#寄存器操作指令>寄存器操作指令</a></li><li><a href=#访存指令>访存指令</a></li><li><a href=#跳转调用及返回指令>跳转，调用及返回指令</a></li><li><a href=#其他指令>其他指令</a></li></ul></li><li><a href=#顺序结构处理器-seq-实现>顺序结构处理器 SEQ 实现</a><ul><li><a href=#取指阶段>取指阶段</a></li><li><a href=#译码阶段>译码阶段</a></li><li><a href=#执行阶段>执行阶段</a><ul><li><a href=#alub和alua的计算><code>aluB</code>和<code>aluA</code>的计算</a></li><li><a href=#ifun计算><code>ifun</code>计算</a></li><li><a href=#条件码设置>条件码设置</a></li><li><a href=#执行阶段-alu-设计>执行阶段 ALU 设计</a></li></ul></li><li><a href=#访存阶段>访存阶段</a><ul><li><a href=#存储器结构>存储器结构</a></li><li><a href=#存储器读>存储器读</a></li><li><a href=#存储器写>存储器写</a></li><li><a href=#访存阶段设计>访存阶段设计</a></li></ul></li><li><a href=#写回阶段>写回阶段</a></li><li><a href=#更新-pc>更新 PC</a></li><li><a href=#各阶段总结>各阶段总结</a><ul><li><a href=#取指>取指</a></li><li><a href=#译码--写回>译码 & 写回</a></li><li><a href=#执行>执行</a></li><li><a href=#访存>访存</a></li><li><a href=#pc-更新>PC 更新</a></li></ul></li></ul></li><li><a href=#流水线原理简介>流水线原理简介</a></li><li><a href=#流水线结构处理器-pipe-实现>流水线结构处理器 PIPE-实现</a></li><li><a href=#包含冒险控制的流水线结构处理器-pipe-实现>包含冒险控制的流水线结构处理器 PIPE 实现</a><ul><li><a href=#控制冒险>控制冒险</a></li><li><a href=#数据冒险>数据冒险</a><ul><li><a href=#用暂停避免数据冒险>用暂停避免数据冒险</a></li><li><a href=#用转发避免数据冒险>用转发避免数据冒险</a></li><li><a href=#加载使用数据冒险>加载/使用数据冒险</a></li></ul></li><li><a href=#避免控制冒险>避免控制冒险</a></li></ul></li><li><a href=#异常处理>异常处理</a></li><li><a href=#pipe-各阶段实现>PIPE 各阶段实现</a><ul><li><a href=#取指阶段-1>取指阶段</a></li><li><a href=#译码及写回阶段>译码及写回阶段</a></li><li><a href=#执行阶段-1>执行阶段</a></li><li><a href=#访存阶段-1>访存阶段</a></li></ul></li><li><a href=#流水线控制逻辑>流水线控制逻辑</a><ul><li><a href=#几种特殊情况及其处理>几种特殊情况及其处理</a><ul><li><a href=#加载使用冒险处理>加载/使用冒险处理</a></li><li><a href=#ret指令处理><code>ret</code>指令处理</a></li><li><a href=#预测错误的分支处理>预测错误的分支处理</a></li><li><a href=#异常处理-1>异常处理</a></li></ul></li><li><a href=#发现特殊控制条件>发现特殊控制条件</a></li><li><a href=#流水线控制机制>流水线控制机制</a></li><li><a href=#流水线三种特殊情况下应该采取的行动>流水线三种特殊情况下应该采取的行动</a></li><li><a href=#控制条件的组合>控制条件的组合</a><ul><li><a href=#组合-ajxx-dest执行阶段--ret-指令译码阶段>组合 A：JXX Dest（执行阶段) + ret 指令(译码阶段)</a></li><li><a href=#组合-b加载使用冒险--ret-指令>组合 B：加载/使用冒险 + ret 指令</a></li></ul></li><li><a href=#控制逻辑实现>控制逻辑实现</a></li><li><a href=#两种测试方法>两种测试方法</a></li></ul></li><li><a href=#性能分析>性能分析</a></li><li><a href=#未完成的工作>未完成的工作</a><ul><li><a href=#多周期指令>多周期指令</a></li><li><a href=#与存储系统的接口>与存储系统的接口</a></li></ul></li><li><a href=#hcl-代码学习>HCL 代码学习</a><ul><li><a href=#hcl-信号说明>HCL 信号说明</a></li><li><a href=#hclquote>HCL<code>quote</code></a></li><li><a href=#hcl-表达式和块>HCL 表达式和块</a></li><li><a href=#hcl-示例>HCL 示例</a></li><li><a href=#hcl-seq-代码分析>HCL SEQ 代码分析</a><ul><li><a href=#头文件引入>头文件引入</a></li><li><a href=#信号声明>信号声明</a></li></ul></li><li><a href=#hcl-pipe-代码分析>HCL PIPE 代码分析</a></li></ul></li><li><a href=#verlog-代码学习>Verlog 代码学习</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div><dialog id=toc-dialog class="tw-max-w-full tw-w-full tw-max-h-full tw-h-full tw-ml-16"><div class="toc tw-mx-4 tw-max-w-full"><h2 class="tw-mx-0 tw-my-6 tw-uppercase tw-text-2xl">目录</h2><div class=toc-content><nav id=TableOfContents><ul><li><a href=#y86_64-指令集架构>Y86_64 指令集架构</a><ul><li><a href=#寄存器操作指令>寄存器操作指令</a></li><li><a href=#访存指令>访存指令</a></li><li><a href=#跳转调用及返回指令>跳转，调用及返回指令</a></li><li><a href=#其他指令>其他指令</a></li></ul></li><li><a href=#顺序结构处理器-seq-实现>顺序结构处理器 SEQ 实现</a><ul><li><a href=#取指阶段>取指阶段</a></li><li><a href=#译码阶段>译码阶段</a></li><li><a href=#执行阶段>执行阶段</a><ul><li><a href=#alub和alua的计算><code>aluB</code>和<code>aluA</code>的计算</a></li><li><a href=#ifun计算><code>ifun</code>计算</a></li><li><a href=#条件码设置>条件码设置</a></li><li><a href=#执行阶段-alu-设计>执行阶段 ALU 设计</a></li></ul></li><li><a href=#访存阶段>访存阶段</a><ul><li><a href=#存储器结构>存储器结构</a></li><li><a href=#存储器读>存储器读</a></li><li><a href=#存储器写>存储器写</a></li><li><a href=#访存阶段设计>访存阶段设计</a></li></ul></li><li><a href=#写回阶段>写回阶段</a></li><li><a href=#更新-pc>更新 PC</a></li><li><a href=#各阶段总结>各阶段总结</a><ul><li><a href=#取指>取指</a></li><li><a href=#译码--写回>译码 & 写回</a></li><li><a href=#执行>执行</a></li><li><a href=#访存>访存</a></li><li><a href=#pc-更新>PC 更新</a></li></ul></li></ul></li><li><a href=#流水线原理简介>流水线原理简介</a></li><li><a href=#流水线结构处理器-pipe-实现>流水线结构处理器 PIPE-实现</a></li><li><a href=#包含冒险控制的流水线结构处理器-pipe-实现>包含冒险控制的流水线结构处理器 PIPE 实现</a><ul><li><a href=#控制冒险>控制冒险</a></li><li><a href=#数据冒险>数据冒险</a><ul><li><a href=#用暂停避免数据冒险>用暂停避免数据冒险</a></li><li><a href=#用转发避免数据冒险>用转发避免数据冒险</a></li><li><a href=#加载使用数据冒险>加载/使用数据冒险</a></li></ul></li><li><a href=#避免控制冒险>避免控制冒险</a></li></ul></li><li><a href=#异常处理>异常处理</a></li><li><a href=#pipe-各阶段实现>PIPE 各阶段实现</a><ul><li><a href=#取指阶段-1>取指阶段</a></li><li><a href=#译码及写回阶段>译码及写回阶段</a></li><li><a href=#执行阶段-1>执行阶段</a></li><li><a href=#访存阶段-1>访存阶段</a></li></ul></li><li><a href=#流水线控制逻辑>流水线控制逻辑</a><ul><li><a href=#几种特殊情况及其处理>几种特殊情况及其处理</a><ul><li><a href=#加载使用冒险处理>加载/使用冒险处理</a></li><li><a href=#ret指令处理><code>ret</code>指令处理</a></li><li><a href=#预测错误的分支处理>预测错误的分支处理</a></li><li><a href=#异常处理-1>异常处理</a></li></ul></li><li><a href=#发现特殊控制条件>发现特殊控制条件</a></li><li><a href=#流水线控制机制>流水线控制机制</a></li><li><a href=#流水线三种特殊情况下应该采取的行动>流水线三种特殊情况下应该采取的行动</a></li><li><a href=#控制条件的组合>控制条件的组合</a><ul><li><a href=#组合-ajxx-dest执行阶段--ret-指令译码阶段>组合 A：JXX Dest（执行阶段) + ret 指令(译码阶段)</a></li><li><a href=#组合-b加载使用冒险--ret-指令>组合 B：加载/使用冒险 + ret 指令</a></li></ul></li><li><a href=#控制逻辑实现>控制逻辑实现</a></li><li><a href=#两种测试方法>两种测试方法</a></li></ul></li><li><a href=#性能分析>性能分析</a></li><li><a href=#未完成的工作>未完成的工作</a><ul><li><a href=#多周期指令>多周期指令</a></li><li><a href=#与存储系统的接口>与存储系统的接口</a></li></ul></li><li><a href=#hcl-代码学习>HCL 代码学习</a><ul><li><a href=#hcl-信号说明>HCL 信号说明</a></li><li><a href=#hclquote>HCL<code>quote</code></a></li><li><a href=#hcl-表达式和块>HCL 表达式和块</a></li><li><a href=#hcl-示例>HCL 示例</a></li><li><a href=#hcl-seq-代码分析>HCL SEQ 代码分析</a><ul><li><a href=#头文件引入>头文件引入</a></li><li><a href=#信号声明>信号声明</a></li></ul></li><li><a href=#hcl-pipe-代码分析>HCL PIPE 代码分析</a></li></ul></li><li><a href=#verlog-代码学习>Verlog 代码学习</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div></dialog><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single print:!tw-w-full print:!tw-max-w-none print:!tw-m-0 print:!tw-p-0"><h1 class=single-title data-pagefind-meta=date:2024-03-13 data-pagefind-body>CSAPP Chapter 4 - 处理器体系结构</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><span class=screen-reader-text></span><a href=https://salvely.github.io/authors/salvely/><img class="tw-inline-block tw-max-h-4 tw-rounded-full tw-translate-y-[-2px] tw-mr-1" src=/images/Salvely.jpg srcset="/images/Salvely_hu_d1b6716dad6d20f5.webp 16w, /images/Salvely_hu_e7e468e0168e4ede.webp 24w, /images/Salvely_hu_67e7b6815a7669d2.webp 32w" alt="Wen Gao avatar" height=16 width=16>Wen Gao</a></span>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/><svg class="icon" viewBox="0 0 512 512"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>系统入门</a>&nbsp;<a href=/categories/%E7%B1%BB%E5%88%AB/><svg class="icon" viewBox="0 0 512 512"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>类别</a></span>&nbsp;<span class=post-category>和</span>&nbsp;<span class=post-series>系列 <a href=/series/15-213/><svg class="icon" viewBox="0 0 512 512"><path d="M464 32H48C21.49 32 0 53.49.0 80v352c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zm-6 4e2H54a6 6 0 01-6-6V86a6 6 0 016-6h404a6 6 0 016 6v340a6 6 0 01-6 6zm-42-92v24c0 6.627-5.373 12-12 12H204c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h2e2c6.627.0 12 5.373 12 12zm0-96v24c0 6.627-5.373 12-12 12H204c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h2e2c6.627.0 12 5.373 12 12zm0-96v24c0 6.627-5.373 12-12 12H204c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h2e2c6.627.0 12 5.373 12 12zm-252 12c0 19.882-16.118 36-36 36s-36-16.118-36-36 16.118-36 36-36 36 16.118 36 36zm0 96c0 19.882-16.118 36-36 36s-36-16.118-36-36 16.118-36 36-36 36 16.118 36 36zm0 96c0 19.882-16.118 36-36 36s-36-16.118-36-36 16.118-36 36-36 36 16.118 36 36z"/></svg>15-213</a></span></div><div class=post-meta-line><svg class="icon" viewBox="0 0 448 512"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;<time datetime=2024-03-13>2024-03-13</time>&nbsp;<svg class="icon" viewBox="0 0 576 512"><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1.0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7.0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174 402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7-43.2-43.2c-4.1-4.1-10.8-4.1-14.8.0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg>&nbsp;<time datetime=2025-03-21>2025-03-21</time>&nbsp;<svg class="icon" viewBox="0 0 512 512"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3.0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9.0l60.1 60.1c18.8 18.7 18.8 49.1.0 67.9zM284.2 99.8 21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3.0-17l-111-111c-4.8-4.7-12.4-4.7-17.1.0zM124.1 339.9c-5.5-5.5-5.5-14.3.0-19.8l154-154c5.5-5.5 14.3-5.5 19.8.0s5.5 14.3.0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8.0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;约 15037 字&nbsp;
<svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5.0-2e2-89.5-2e2-2e2S145.5 56 256 56s2e2 89.5 2e2 2e2-89.5 2e2-2e2 2e2zm61.8-104.4-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6.0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;预计阅读 66 分钟&nbsp;</div></div><div class="details series-nav open"><div class="details-summary series-title"><span>系列 - 15-213</span>
<span class=details-icon><svg class="icon" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9.0l-22.6-22.6c-9.4-9.4-9.4-24.6.0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6.0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9.0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></span></div><div class="details-content series-content"><nav><ul><li><a href=/ch5/>CSAPP Ch5：优化程序性能</a></li><li><a href=/arch-lab%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/>Arch Lab实验总结</a></li><li><span class=active>CSAPP Chapter 4 - 处理器体系结构</span></li><li><a href=/attack-lab-recitation/>Attack lab recitation</a></li><li><a href=/bomb-lab-recitation/>Bomb lab recitation</a></li><li><a href=/machine-procedures-activity/>Machine procedures activity</a></li><li><a href=/machine-data-activity/>Machine data activity</a></li><li><a href=/machine-control-activity/>Machine control activity</a></li><li><a href=/bomb-lab-activity/>Bomb lab activity</a></li><li><a href=/gdb-asm-activity/>gdb & asm activity</a></li><li><a href=/ch3/>CSAPP Ch3：程序的机器级表示</a></li><li><a href=/ch2/>CSAPP Chapter 2 - 信息的表示和处理 阅读笔记</a></li><li><a href=/ch1/>CSAPP Ch1：计算机系统漫游</a></li><li><a href=/attack-lab-%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/>Attack lab 实验总结</a></li><li><a href=/bomb-lab-%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/>Bomb lab 实验总结</a></li><li><a href=/data-lab-%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/>Data lab 实验总结</a></li><li><a href=/ch6/>CSAPP Ch6：存储器层次结构</a></li></ul></nav></div></div><div class="details toc print:!tw-block" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span class=details-icon><svg class="icon" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9.0l-22.6-22.6c-9.4-9.4-9.4-24.6.0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6.0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9.0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#y86_64-指令集架构>Y86_64 指令集架构</a><ul><li><a href=#寄存器操作指令>寄存器操作指令</a></li><li><a href=#访存指令>访存指令</a></li><li><a href=#跳转调用及返回指令>跳转，调用及返回指令</a></li><li><a href=#其他指令>其他指令</a></li></ul></li><li><a href=#顺序结构处理器-seq-实现>顺序结构处理器 SEQ 实现</a><ul><li><a href=#取指阶段>取指阶段</a></li><li><a href=#译码阶段>译码阶段</a></li><li><a href=#执行阶段>执行阶段</a><ul><li><a href=#alub和alua的计算><code>aluB</code>和<code>aluA</code>的计算</a></li><li><a href=#ifun计算><code>ifun</code>计算</a></li><li><a href=#条件码设置>条件码设置</a></li><li><a href=#执行阶段-alu-设计>执行阶段 ALU 设计</a></li></ul></li><li><a href=#访存阶段>访存阶段</a><ul><li><a href=#存储器结构>存储器结构</a></li><li><a href=#存储器读>存储器读</a></li><li><a href=#存储器写>存储器写</a></li><li><a href=#访存阶段设计>访存阶段设计</a></li></ul></li><li><a href=#写回阶段>写回阶段</a></li><li><a href=#更新-pc>更新 PC</a></li><li><a href=#各阶段总结>各阶段总结</a><ul><li><a href=#取指>取指</a></li><li><a href=#译码--写回>译码 & 写回</a></li><li><a href=#执行>执行</a></li><li><a href=#访存>访存</a></li><li><a href=#pc-更新>PC 更新</a></li></ul></li></ul></li><li><a href=#流水线原理简介>流水线原理简介</a></li><li><a href=#流水线结构处理器-pipe-实现>流水线结构处理器 PIPE-实现</a></li><li><a href=#包含冒险控制的流水线结构处理器-pipe-实现>包含冒险控制的流水线结构处理器 PIPE 实现</a><ul><li><a href=#控制冒险>控制冒险</a></li><li><a href=#数据冒险>数据冒险</a><ul><li><a href=#用暂停避免数据冒险>用暂停避免数据冒险</a></li><li><a href=#用转发避免数据冒险>用转发避免数据冒险</a></li><li><a href=#加载使用数据冒险>加载/使用数据冒险</a></li></ul></li><li><a href=#避免控制冒险>避免控制冒险</a></li></ul></li><li><a href=#异常处理>异常处理</a></li><li><a href=#pipe-各阶段实现>PIPE 各阶段实现</a><ul><li><a href=#取指阶段-1>取指阶段</a></li><li><a href=#译码及写回阶段>译码及写回阶段</a></li><li><a href=#执行阶段-1>执行阶段</a></li><li><a href=#访存阶段-1>访存阶段</a></li></ul></li><li><a href=#流水线控制逻辑>流水线控制逻辑</a><ul><li><a href=#几种特殊情况及其处理>几种特殊情况及其处理</a><ul><li><a href=#加载使用冒险处理>加载/使用冒险处理</a></li><li><a href=#ret指令处理><code>ret</code>指令处理</a></li><li><a href=#预测错误的分支处理>预测错误的分支处理</a></li><li><a href=#异常处理-1>异常处理</a></li></ul></li><li><a href=#发现特殊控制条件>发现特殊控制条件</a></li><li><a href=#流水线控制机制>流水线控制机制</a></li><li><a href=#流水线三种特殊情况下应该采取的行动>流水线三种特殊情况下应该采取的行动</a></li><li><a href=#控制条件的组合>控制条件的组合</a><ul><li><a href=#组合-ajxx-dest执行阶段--ret-指令译码阶段>组合 A：JXX Dest（执行阶段) + ret 指令(译码阶段)</a></li><li><a href=#组合-b加载使用冒险--ret-指令>组合 B：加载/使用冒险 + ret 指令</a></li></ul></li><li><a href=#控制逻辑实现>控制逻辑实现</a></li><li><a href=#两种测试方法>两种测试方法</a></li></ul></li><li><a href=#性能分析>性能分析</a></li><li><a href=#未完成的工作>未完成的工作</a><ul><li><a href=#多周期指令>多周期指令</a></li><li><a href=#与存储系统的接口>与存储系统的接口</a></li></ul></li><li><a href=#hcl-代码学习>HCL 代码学习</a><ul><li><a href=#hcl-信号说明>HCL 信号说明</a></li><li><a href=#hclquote>HCL<code>quote</code></a></li><li><a href=#hcl-表达式和块>HCL 表达式和块</a></li><li><a href=#hcl-示例>HCL 示例</a></li><li><a href=#hcl-seq-代码分析>HCL SEQ 代码分析</a><ul><li><a href=#头文件引入>头文件引入</a></li><li><a href=#信号声明>信号声明</a></li></ul></li><li><a href=#hcl-pipe-代码分析>HCL PIPE 代码分析</a></li></ul></li><li><a href=#verlog-代码学习>Verlog 代码学习</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=content id=content data-pagefind-body><p>本章中我们需要实现 3 个目标：</p><ul><li>设计一个顺序结构的 Y86_64 架构处理器</li><li>设计一个流水线结构的 Y86_64 架构处理器</li><li>设计一个包含冒险控制的 Y86_64 架构处理器</li></ul><h2 id=y86_64-指令集架构 class=headerLink><a href=#y86_64-%e6%8c%87%e4%bb%a4%e9%9b%86%e6%9e%b6%e6%9e%84 class=header-mark></a>1 Y86_64 指令集架构</h2><p>Y86_64 指令集架构的基本格式如下：</p><ul><li>1 字节的指令指示符，包含 4 位的代码段和 4 位的功能段</li><li>1 字节的寄存器指示符（部分指令没有）</li><li>8 个字节的常数（部分指令没有）</li></ul><p>此外，Y86_64 指令集架构包含 16 个寄存器，编号为：0-F，其中<code>F</code>表示这条指令无需寄存器，此外<code>%rsp</code>寄存器的值为 4。并且 Y86_64 处理器的异常处理机制就是让处理器停止执行指令。</p><p>根据指令的不同特性，我们将其分为不同的类别来进行分析。指令的指令可以概括的分为 6 个阶段：</p><ul><li>取指：从 PC 中取出指令，分割其内部字段，如<code>icode</code>、<code>ifun</code>，寄存器指示符<code>rA</code>和<code>rB</code>，立即数<code>valC</code>等等</li><li>译码：根据取指阶段各个字段，去寄存器中把值拿出来，得到两个数<code>valA</code>和<code>valB</code></li><li>执行：将寄存器中拿出的值放入<code>ALU</code>计算单元，中途还需要判断<code>icode</code>和<code>ifun</code>等，计算出的值为<code>valE</code></li><li>访存：访问内存，读出的值为<code>valM</code></li><li>写回：将结果写回寄存器</li><li>更新 PC：根据不同指令更新 PC，默认的下一条指令地址为<code>valP</code></li></ul><h3 id=寄存器操作指令 class=headerLink><a href=#%e5%af%84%e5%ad%98%e5%99%a8%e6%93%8d%e4%bd%9c%e6%8c%87%e4%bb%a4 class=header-mark></a>1.1 寄存器操作指令</h3><p>符合这个类别的指令包括：<code>rrmovq</code>，<code>irmovq</code>，<code>OPq</code></p><p>将这三条指令按上述过程分析如下：</p><div class=table-wrapper><table><thead><tr><th style=text-align:>阶段</th><th style=text-align:><code>rrmovq</code></th><th style=text-align:><code>irmovq</code></th><th style=text-align:><code>OPq</code></th></tr></thead><tbody><tr><td style=text-align:>取指</td><td style=text-align:>$icode:ifun\leftarrow M_{1}[PC]$<br>$rA:rB\leftarrow M_{1}[PC+1]$<br><br>$valP\leftarrow PC+2$</td><td style=text-align:>$icode:ifun\leftarrow M_{1}[PC]$<br>$rA:rB\leftarrow M_{1}[PC+1]$<br>$valC\leftarrow M_{8}[PC+2]$<br>$valP\leftarrow PC + 10$</td><td style=text-align:>$icode:ifun\leftarrow M_{1}[PC]$<br>$rA:rB\leftarrow M_{1}[PC+1]$<br><br>$valP\leftarrow PC+2$</td></tr><tr><td style=text-align:>译码</td><td style=text-align:>$valA\leftarrow R[rA]$<br><br></td><td style=text-align:></td><td style=text-align:>$valA\leftarrow R[rA]$<br>$valB\leftarrow R[rB]$</td></tr><tr><td style=text-align:>执行</td><td style=text-align:>$valE\leftarrow valB\space OP\space valA$</td><td style=text-align:>$valE\leftarrow 0\space OP\space valC$</td><td style=text-align:>$valE\leftarrow 0\space OP\space valA$</td></tr><tr><td style=text-align:>访存</td><td style=text-align:></td><td style=text-align:></td><td style=text-align:></td></tr><tr><td style=text-align:>写回</td><td style=text-align:><td colspan=2>$R[rB]\leftarrow valE$</td></td><td style=text-align:></td><td style=text-align:></td></tr><tr><td style=text-align:>更新 PC</td><td style=text-align:><td colspan=2>$PC\leftarrow valP$</td></td><td style=text-align:></td><td style=text-align:></td></tr></tbody></table></div><h3 id=访存指令 class=headerLink><a href=#%e8%ae%bf%e5%ad%98%e6%8c%87%e4%bb%a4 class=header-mark></a>1.2 访存指令</h3><p>符合这个类别的指令包括：<code>rmmovq</code>，<code>mrmovq</code>，<code>pushq</code>，<code>popq</code></p><div class=table-wrapper><table><thead><tr><th style=text-align:>阶段</th><th style=text-align:><code>rmmovq</code></th><th style=text-align:><code>mrmovq</code></th><th style=text-align:><code>pushq</code></th><th style=text-align:><code>popq</code></th></tr></thead><tbody><tr><td style=text-align:>取指</td><td style=text-align:><td colspan=3>$icode:ifun\leftarrow M_{1}[PC]$<br>$rA:rB\leftarrow M_{1}[PC+1]$<td></td><td style=text-align:></td><td style=text-align:></td><td style=text-align:></td></tr><tr><td style=text-align:></td><td style=text-align:>$valC\leftarrow M_{8}[PC+2]$</td><td style=text-align:>$valC\leftarrow M_{8}[PC+2]$</td><td style=text-align:></td><td style=text-align:></td></tr><tr><td style=text-align:></td><td style=text-align:>$valP\leftarrow PC+10$</td><td style=text-align:>$valP\leftarrow PC+10$</td><td style=text-align:>$valP\leftarrow PC+2$</td><td style=text-align:>$valP\leftarrow PC+2$</td></tr><tr><td style=text-align:>译码</td><td style=text-align:>$valA\leftarrow R[rA]$<br>$valB\leftarrow R[rB]$</td><td style=text-align:><br>$valB\leftarrow R[rB]$</td><td style=text-align:>$valA\leftarrow R[rA]$<br>$valB\leftarrow R[rsp]$</td><td style=text-align:>$valA\leftarrow R[rsp]$<br>$valB\leftarrow R[rsp]$</td></tr><tr><td style=text-align:>执行</td><td style=text-align:>$valE\leftarrow valB+valC$</td><td style=text-align:>$valE\leftarrow valB+valC$</td><td style=text-align:>$valE\leftarrow valB+(-8)$</td><td style=text-align:>$valE\leftarrow valB+8$</td></tr><tr><td style=text-align:>访存</td><td style=text-align:>$M[valE]\leftarrow valA$</td><td style=text-align:>$valM\leftarrow M[valE]$</td><td style=text-align:>$M[valE]\leftarrow valA$</td><td style=text-align:>$valM\leftarrow M[valA]$</td></tr><tr><td style=text-align:>写回</td><td style=text-align:></td><td style=text-align:>$R[rA]\leftarrow valM$</td><td style=text-align:>$R[rsp]\leftarrow valE$</td><td style=text-align:>$R[rsp]\leftarrow valE$<br>$R[rA]\leftarrow valM$</td></tr><tr><td style=text-align:>更新 PC</td><td style=text-align:><td colspan=4>$PC\leftarrow valP$</td></td><td style=text-align:></td><td style=text-align:></td><td style=text-align:></td></tr></tbody></table></div><h3 id=跳转调用及返回指令 class=headerLink><a href=#%e8%b7%b3%e8%bd%ac%e8%b0%83%e7%94%a8%e5%8f%8a%e8%bf%94%e5%9b%9e%e6%8c%87%e4%bb%a4 class=header-mark></a>1.3 跳转，调用及返回指令</h3><p>符合这个类别的指令包括：<code>jXX</code>，<code>cmovXX</code>，<code>call</code>，<code>ret</code>。这些指令中的部分指令也需要访存，并且涉及到修改 PC。</p><div class=table-wrapper><table><thead><tr><th style=text-align:>阶段</th><th style=text-align:><code>call</code></th><th style=text-align:><code>cmovXX</code></th><th style=text-align:><code>jXX</code></th><th style=text-align:><code>ret</code></th></tr></thead><tbody><tr><td style=text-align:>取指</td><td style=text-align:>$icode:ifun\leftarrow M_{1}[PC]$<br>$valC\leftarrow M_{8}[PC+1]$<br>$valP\leftarrow PC+9$</td><td style=text-align:>$icode:ifun\leftarrow M_{1}[PC]$<br>$rA：rB\leftarrow M_{1}[PC+1]$<br>$valP\leftarrow PC+2$</td><td style=text-align:>$icode:ifun\leftarrow M_{1}[PC]$<br>$valC\leftarrow M_{8}[PC+1]$<br>$valP\leftarrow PC+9$</td><td style=text-align:>$icode:ifun\leftarrow M_{1}[PC]$<br><br><br>$valP\leftarrow PC+1$</td></tr><tr><td style=text-align:>译码</td><td style=text-align:>$valB\leftarrow R[rsp]$</td><td style=text-align:>$valA\leftarrow R[rA]$</td><td style=text-align:></td><td style=text-align:>$valA\leftarrow R[rsp]$<br>$valB\leftarrow R[rsp]$</td></tr><tr><td style=text-align:>执行</td><td style=text-align:>$valE\leftarrow valB+(-8)$</td><td style=text-align:></td><td style=text-align:>$Cnd\leftarrow Cond(CC,ifun)$</td><td style=text-align:>$valE\leftarrow valB+8$</td></tr><tr><td style=text-align:>访存</td><td style=text-align:>$M[valE]\leftarrow valP$</td><td style=text-align:></td><td style=text-align:></td><td style=text-align:>$valM\leftarrow M[valA]$</td></tr><tr><td style=text-align:>写回</td><td style=text-align:>$R[rsp]\leftarrow valE$</td><td style=text-align:>$R[rB]\leftarrow Cnd?valA$</td><td style=text-align:></td><td style=text-align:>$R[rsp]\leftarrow valE$</td></tr><tr><td style=text-align:>更新 PC</td><td style=text-align:>$PC\leftarrow valC$</td><td style=text-align:>$PC\leftarrow valP$</td><td style=text-align:>$PC\leftarrow Cnd?valC;valP$</td><td style=text-align:>$PC\leftarrow valM$</td></tr></tbody></table></div><h3 id=其他指令 class=headerLink><a href=#%e5%85%b6%e4%bb%96%e6%8c%87%e4%bb%a4 class=header-mark></a>1.4 其他指令</h3><p>符合这个类别的指令包括：<code>halt</code>，<code>nop</code></p><div class=table-wrapper><table><thead><tr><th style=text-align:>阶段</th><th style=text-align:><code>halt</code></th><th style=text-align:><code>nop</code></th></tr></thead><tbody><tr><td style=text-align:>取指</td><td style=text-align:>$icode:ifun\leftarrow M_{1}[PC]$<br>$valP\leftarrow PC+1$</td><td style=text-align:>$icode:ifun\leftarrow M_{1}[PC]$<br>$valP\leftarrow PC+1$</td></tr><tr><td style=text-align:>译码</td><td style=text-align:></td><td style=text-align:></td></tr><tr><td style=text-align:>执行</td><td style=text-align:>set CC</td><td style=text-align:></td></tr><tr><td style=text-align:>访存</td><td style=text-align:></td><td style=text-align:></td></tr><tr><td style=text-align:>写回</td><td style=text-align:></td><td style=text-align:></td></tr><tr><td style=text-align:>更新 PC</td><td style=text-align:>$PC\leftarrow valP$</td><td style=text-align:>$PC\leftarrow valP$</td></tr></tbody></table></div><h2 id=顺序结构处理器-seq-实现 class=headerLink><a href=#%e9%a1%ba%e5%ba%8f%e7%bb%93%e6%9e%84%e5%a4%84%e7%90%86%e5%99%a8-seq-%e5%ae%9e%e7%8e%b0 class=header-mark></a>2 顺序结构处理器 SEQ 实现</h2><h3 id=取指阶段 class=headerLink><a href=#%e5%8f%96%e6%8c%87%e9%98%b6%e6%ae%b5 class=header-mark></a>2.1 取指阶段</h3><p>取值阶段做的工作主要是从指令中抽出几个字段，然后对其进行判断，并且生成一些信号。</p><p>生成的字段包括：</p><ul><li><code>icode</code>：所有指令都生成这个字段</li><li><code>ifun</code>：所有指令都生成这个字段</li><li><code>rA</code>：<code>rrmovq</code>,<code>irmovq</code>,<code>OPq</code>,<code>rmmovq</code>,<code>mrmovq</code>,<code>pushq</code>,<code>popq</code>,<code>cmovXX</code></li><li><code>rB</code>：<code>rrmovq</code>,<code>irmovq</code>,<code>OPq</code>,<code>rmmovq</code>,<code>mrmovq</code>,<code>pushq</code>,<code>popq</code>,<code>cmovXX</code></li><li><code>valC</code>：<code>irmovq,mrmovq,rmmovq,jxx,call</code></li><li><code>valP</code>：所有指令都生成这个字段，但是其值不一样，根据<code>icode</code>和<code>ifun</code>来变化</li></ul><p>其可以产生的信号包括：</p><ul><li><p><code>icode</code>和<code>ifun</code></p></li><li><p><code>needReg</code>，表示是否需要寄存器，其计算方式如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-1 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word needReg</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>  <span class=k>icode</span> <span class=k>in</span> {
</span></span><span class=line><span class=cl>      <span class=k>IRRMOVQ</span><span class=p>,</span><span class=k>IIRMOVQ</span><span class=p>,</span><span class=k>IOPQ</span><span class=p>,</span><span class=k>IRMMOVQ</span><span class=p>,</span><span class=k>IMRMOVQ</span><span class=p>,</span><span class=k>IPUSHQ</span><span class=p>,</span><span class=k>IPOPQ</span>
</span></span><span class=line><span class=cl>  }<span class=err>;</span></span></span></code></pre></div></li><li><p><code>needValC</code>，表示是否需要立即数，其计算方式如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-2 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>  word needValC</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>  <span class=k>icode</span> <span class=k>in</span> {
</span></span><span class=line><span class=cl>      <span class=k>IIRMOVQ</span><span class=p>,</span><span class=k>IMRMOVQ</span><span class=p>,</span><span class=k>IRMMOVQ</span><span class=p>,</span><span class=k>IJXX</span><span class=p>,</span><span class=k>ICALL</span>
</span></span><span class=line><span class=cl>  }<span class=err>;</span></span></span></code></pre></div></li><li><p>$valP = pc + 1 + needReg + 8 * needValC$</p></li></ul><p>其可以产生的异常信号包括：</p><ul><li>指令异常<code>instr_valid</code></li><li>寄存器地址异常<code>imem_error</code>（需要将指令转化为<code>nop</code>）</li></ul><p>我们在取值阶段的设计如图：</p><p><img class=tw-inline loading=lazy src=/ch4/SEQ%E5%8F%96%E6%8C%87.png srcset="/ch4/SEQ%E5%8F%96%E6%8C%87_hu_5a4463e80800a786.webp 800w, /ch4/SEQ%E5%8F%96%E6%8C%87_hu_1b6c61d91e4ffd71.webp 1200w, /ch4/SEQ%E5%8F%96%E6%8C%87_hu_819c4a8c89b37b37.webp 1600w" alt=SEQ取指 height=741 width=641></p><h3 id=译码阶段 class=headerLink><a href=#%e8%af%91%e7%a0%81%e9%98%b6%e6%ae%b5 class=header-mark></a>2.2 译码阶段</h3><p>译码阶段主要产生实现寄存器的值读取，其可以读取到<code>valA</code>，<code>valB</code>。其值来源有多种，包括<code>rA</code>,<code>rB</code>,<code>rsp</code>。<code>valA</code>的值一般来源于<code>rA</code>，<code>valB</code>的值可能来源于<code>rB</code>，也可能来源于<code>rsp</code>。</p><p>我们的寄存器文件含有 2 个读端口，其读端口地址为<code>srcA</code>和<code>srcB</code>，读端口数据为<code>valA</code>和<code>valB</code>。还有一个写端口，写端口的地址为<code>dstW</code>，数据为<code>valW</code>。</p><p>在这个设计中，我们让<code>valA</code>进入<code>srcA</code>，<code>valB</code>进入<code>srcB</code>。</p><p>其中，<code>srcA</code>(<code>valA</code>)可能值为<code>rA</code>,<code>rsp</code>和<code>RNONE</code>，不同指令对应的<code>hcl</code>代码如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-3 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word srcA</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=k>icode</span> <span class=k>in</span> {<span class=k>IRRMOVQ</span><span class=p>,</span><span class=k>IOPQ</span><span class=p>,</span><span class=k>RMMOVQ</span><span class=p>,</span><span class=k>PUSHQ</span>}<span class=err>:</span><span class=k>rA</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=k>icode</span> <span class=k>in</span> {<span class=k>IPOPQ</span><span class=p>,</span><span class=k>IRET</span>}<span class=err>:</span><span class=k>RRSP</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=m>1</span><span class=err>:</span><span class=k>RNONE</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=p>]</span><span class=err>;</span></span></span></code></pre></div><p><code>srcB</code>(<code>valB</code>)的可能值为<code>rB</code>和<code>rsp</code>和<code>RNONE</code>。其<code>hcl</code>代码如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-4 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word srcB</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=k>icode</span> <span class=k>in</span> {<span class=k>IOPQ</span><span class=p>,</span><span class=k>RMMOVQ</span><span class=p>,</span><span class=k>MRMOVQ</span>}<span class=err>:</span><span class=k>rB</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=k>icode</span> <span class=k>in</span> {<span class=k>IPUSHQ</span><span class=p>,</span><span class=k>IPOPQ</span><span class=p>,</span><span class=k>IJXX</span><span class=p>,</span><span class=k>IRET</span>}<span class=err>:</span><span class=k>RRSP</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=m>1</span><span class=err>:</span><span class=k>RNONE</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><p>我们在译码阶段的设计如图(RNONE 未画出)：</p><p><img class=tw-inline loading=lazy src=/ch4/decode.png srcset="/ch4/decode_hu_b3dac9f3cce1ba08.webp 800w, /ch4/decode_hu_bccf9f68a99cf0a1.webp 1200w, /ch4/decode_hu_d2a6baef51846f9f.webp 1600w" alt=译码设计 height=361 width=361></p><h3 id=执行阶段 class=headerLink><a href=#%e6%89%a7%e8%a1%8c%e9%98%b6%e6%ae%b5 class=header-mark></a>2.3 执行阶段</h3><p>执行阶段主要是利用运算器 ALU，其中我们由<code>aluA</code>和<code>aluB</code>进行<code>ifun</code>计算，得到<code>valE</code>。这一步需要：</p><ul><li>计算出<code>aluA</code>和<code>aluB</code></li><li>根据<code>ifun</code>的值来进行计算</li><li>设置条件码<code>CC</code></li><li>产生结果<code>valE</code>。能是：</li></ul><h4 id=alub和alua的计算 class=headerLink><a href=#alub%e5%92%8calua%e7%9a%84%e8%ae%a1%e7%ae%97 class=header-mark></a>2.3.1 <code>aluB</code>和<code>aluA</code>的计算</h4><p>根据前述指令分析，<code>aluB</code>的来源可能是：</p><ul><li><code>valB</code>:<code>OPq</code>,<code>rmmovq</code>,<code>mrmovq</code>,<code>pushq</code>,<code>popq</code>,<code>call</code>,<code>ret</code></li><li>0:<code>rrmovq</code>,<code>irmovq</code></li></ul><p><code>aluA</code>的来源可能是：</p><ul><li><code>valA</code>:<code>OPq</code>,<code>rrmovq</code></li><li><code>valC</code>:<code>irmovq</code>,<code>rmmovq</code>,<code>mrmovq</code></li><li>-8:<code>pushq</code>,<code>call</code></li><li>8:<code>popq</code>,<code>ret</code></li></ul><h4 id=ifun计算 class=headerLink><a href=#ifun%e8%ae%a1%e7%ae%97 class=header-mark></a>2.3.2 <code>ifun</code>计算</h4><p>只有在<code>OPq</code>指令中会用到<code>ifun</code>，其<code>hcl</code>代码为：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-5 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word alufun</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl><span class=n>    icode</span> <span class=o>==</span> <span class=k>IOPQ</span><span class=err>:</span><span class=k>ifun</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=m>1</span><span class=err>:</span><span class=k>ALUADD</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=p>]</span><span class=err>;</span></span></span></code></pre></div><h4 id=条件码设置 class=headerLink><a href=#%e6%9d%a1%e4%bb%b6%e7%a0%81%e8%ae%be%e7%bd%ae class=header-mark></a>2.3.3 条件码设置</h4><p>只有<code>OPq</code>指令设置条件码。因此<code>hcl</code>代码如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-6 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>bool set_cc</span> <span class=o>=</span> <span class=k>icode</span> <span class=k>in</span> {<span class=k>IOPQ</span>}<span class=err>;</span></span></span></code></pre></div><h4 id=执行阶段-alu-设计 class=headerLink><a href=#%e6%89%a7%e8%a1%8c%e9%98%b6%e6%ae%b5-alu-%e8%ae%be%e8%ae%a1 class=header-mark></a>2.3.4 执行阶段 ALU 设计</h4><p>执行阶段的 ALU 设计如下：</p><p><img class=tw-inline loading=lazy src=/ch4/execute.png srcset="/ch4/execute_hu_9b07d35418ec7c5.webp 800w, /ch4/execute_hu_7b609709548c1ae8.webp 1200w, /ch4/execute_hu_610a5a5c61d9a08f.webp 1600w" alt=执行阶段 height=491 width=521></p><h3 id=访存阶段 class=headerLink><a href=#%e8%ae%bf%e5%ad%98%e9%98%b6%e6%ae%b5 class=header-mark></a>2.4 访存阶段</h3><h4 id=存储器结构 class=headerLink><a href=#%e5%ad%98%e5%82%a8%e5%99%a8%e7%bb%93%e6%9e%84 class=header-mark></a>2.4.1 存储器结构</h4><p>访存阶段需要访问到我们的数据内存，而数据内存的结构是：</p><ul><li>一个读写信号</li><li>一个访存地址错误信号(取指阶段获取的<code>mem_error</code>)</li><li>一个地址</li><li>一个写数据输入</li><li>一个读数据输出</li><li>时钟</li></ul><h4 id=存储器读 class=headerLink><a href=#%e5%ad%98%e5%82%a8%e5%99%a8%e8%af%bb class=header-mark></a>2.4.2 存储器读</h4><p>涉及到对存储器的读的指令包括<code>mrmovq,popq,ret</code></p><p>其读出的地址为：<code>valE</code>,<code>valA</code></p><p>读出的数据保存到<code>valM</code></p><h4 id=存储器写 class=headerLink><a href=#%e5%ad%98%e5%82%a8%e5%99%a8%e5%86%99 class=header-mark></a>2.4.3 存储器写</h4><p>涉及到对存储器写的指令包括<code>rmmovq,pushq,call</code></p><p>其写入的地址为：<code>valE</code></p><p>写入的数据为：<code>valA</code>,<code>valP</code></p><h4 id=访存阶段设计 class=headerLink><a href=#%e8%ae%bf%e5%ad%98%e9%98%b6%e6%ae%b5%e8%ae%be%e8%ae%a1 class=header-mark></a>2.4.4 访存阶段设计</h4><ol><li>读控制信号</li></ol><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-7 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word mem_read</span> <span class=o>=</span> <span class=k>icode</span> <span class=k>in</span> {<span class=k>IMRMOVQ</span><span class=p>,</span> <span class=k>IPOPQ</span><span class=p>,</span> <span class=k>IRET</span>}<span class=err>;</span></span></span></code></pre></div><ol><li>写控制信号</li></ol><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-8 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word mem_write</span> <span class=o>=</span> <span class=k>icode</span> <span class=k>in</span> {<span class=k>IRMMOVQ</span><span class=p>,</span> <span class=k>IPUSHQ</span><span class=p>,</span> <span class=k>ICALL</span>}<span class=err>;</span></span></span></code></pre></div><ol><li>写数据信号(<code>valA</code>,<code>valP</code>)</li></ol><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-9 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word mem_data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=k>icode</span> <span class=k>in</span> {<span class=k>IRMMMOVQ</span><span class=p>,</span><span class=k>IPUSHQ</span>}<span class=err>:</span> <span class=k>valA</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=k>icode</span> <span class=k>in</span> {<span class=k>ICALL</span>}<span class=err>:</span> <span class=k>valP</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=p>]</span><span class=err>;</span></span></span></code></pre></div><ol><li>地址信号(<code>valE</code>,<code>valA</code>)</li></ol><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-10 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word mem_addr</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=k>icode</span> <span class=k>in</span> {<span class=k>IMRMOVQ</span><span class=p>,</span><span class=k>IRMMOVQ</span><span class=p>,</span><span class=k>IPUSH</span><span class=p>,</span><span class=k>ICALL</span>}<span class=err>:</span> <span class=k>valE</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=k>icode</span> <span class=k>in</span> {<span class=k>IPOPQ</span><span class=p>,</span><span class=k>IRET</span>}<span class=err>:</span> <span class=k>valA</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=p>]</span><span class=err>;</span></span></span></code></pre></div><ol><li>生成状态信号<ol><li>取值阶段给出<code>icode</code>，<code>imem_error</code>，<code>instr_valid</code></li><li>生成<code>dmem_error</code>内存访问错误信号</li><li><code>Stat</code>状态码：<code>SAOK</code>,<code>SADR</code>,<code>SINS</code>,<code>SHLT</code></li></ol></li></ol><p>访存阶段设计如图：</p><p><img class=tw-inline loading=lazy src=/ch4/mem.png srcset="/ch4/mem_hu_356967b5895ed48.webp 800w, /ch4/mem_hu_e28e97680548e000.webp 1200w, /ch4/mem_hu_dfe51f043ab9f7f.webp 1600w" alt=访存阶段 height=311 width=586></p><h3 id=写回阶段 class=headerLink><a href=#%e5%86%99%e5%9b%9e%e9%98%b6%e6%ae%b5 class=header-mark></a>2.5 写回阶段</h3><p>写回阶段只能写回两种值，要么是执行阶段产生的<code>valE</code>，要么是访存阶段产生的<code>valM</code>。因此，寄存器上可以有 2 个写端口，一个<code>dstE</code>，一个<code>dstM</code>。并且包含两个数据端口。</p><p><code>dstE</code>写入的地址有：</p><ol><li>写入<code>rB</code>:<code>rrmovq</code>,<code>irmovq</code>,<code>OPq</code></li><li>写入<code>rsp</code>:<code>push</code>,<code>pop</code>,<code>call</code>,<code>ret</code></li></ol><p>其<code>hcl</code>代码如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-11 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word dstE</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=k>icode</span> <span class=k>in</span> {<span class=k>IRRMOVQ</span><span class=p>,</span><span class=k>IIRMOVQ</span><span class=p>,</span><span class=k>IOPQ</span>}<span class=err>:</span> <span class=k>rB</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=k>icode</span> <span class=k>in</span> {<span class=k>IPUSHQ</span><span class=p>,</span><span class=k>IPOPQ</span><span class=p>,</span><span class=k>ICALL</span><span class=p>,</span><span class=k>IRET</span>}<span class=err>:</span> <span class=k>RRSP</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=m>1</span><span class=err>:</span> <span class=k>RNONE</span>
</span></span><span class=line><span class=cl><span class=p>]</span><span class=err>;</span></span></span></code></pre></div><p><code>dstM</code>写入的地址有<code>rA</code>:<code>mrmovq</code>,<code>popq</code>。</p><p>其<code>hcl</code>代码如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-12 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word dstM</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=k>icode</span> <span class=k>in</span> {<span class=k>IMRMOVQ</span><span class=p>,</span><span class=k>IPOPQ</span>}<span class=err>:</span> <span class=k>rA</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=m>1</span><span class=err>:</span><span class=k>RNONE</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=p>]</span><span class=err>;</span></span></span></code></pre></div><p>在译码阶段基础上修改如下(RNONE 未画出)：</p><p><img class=tw-inline loading=lazy src=/ch4/writeback.png srcset="/ch4/writeback_hu_851a30b451c60612.webp 800w, /ch4/writeback_hu_6f73aa51da8607c4.webp 1200w, /ch4/writeback_hu_1222f10a8eeb4287.webp 1600w" alt=写回阶段 height=361 width=521></p><h3 id=更新-pc class=headerLink><a href=#%e6%9b%b4%e6%96%b0-pc class=header-mark></a>2.6 更新 PC</h3><p>PC 的值有以下几种可能：</p><ul><li><code>valP</code>: 正常的下一条指令。主要来源于<code>rrmovq,irmovq,OPq,rmmovq,mrmovq,pushq,popq</code></li><li><code>valC</code>: 跳转指令规定的特定指令地址。主要来源于<code>call</code></li><li><code>valM</code>: <code>ret</code>时的返回地址。主要来源于<code>ret</code></li></ul><p>此外，<code>jxx</code>指令的结果是<code>valC</code>还是<code>valP</code>需要视察<code>Cnd</code>而定。</p><p>因此，PC 的值的更新需要几个信号：</p><ul><li><code>icode</code></li><li><code>Cnd</code></li></ul><p>其<code>hcl</code>代码如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-13 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word new_pc</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl><span class=n>    icode</span> <span class=o>==</span> <span class=k>ICALL</span><span class=err>:</span> <span class=k>valC</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=n>    icode</span> <span class=o>==</span> <span class=k>IJXX</span> <span class=err>&amp;&amp;</span> <span class=k>Cnd</span><span class=err>:</span> <span class=k>valC</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=n>    icode</span> <span class=o>==</span> <span class=k>IRET</span><span class=err>:</span> <span class=k>valM</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=m>1</span><span class=err>:</span> <span class=k>valP</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><p>PC 更新部分设计如下：</p><p><img class=tw-inline loading=lazy src=/ch4/updatepc.png srcset="/ch4/updatepc_hu_8e2156fffea93c59.webp 800w, /ch4/updatepc_hu_8c754a0bacbedf10.webp 1200w, /ch4/updatepc_hu_d08b26d967a90850.webp 1600w" alt=PC更新 height=211 width=226></p><h3 id=各阶段总结 class=headerLink><a href=#%e5%90%84%e9%98%b6%e6%ae%b5%e6%80%bb%e7%bb%93 class=header-mark></a>2.7 各阶段总结</h3><h4 id=取指 class=headerLink><a href=#%e5%8f%96%e6%8c%87 class=header-mark></a>2.7.1 取指</h4><p>输入：根据 PC 从指令存储器中取出的指令</p><p>输出：</p><ul><li>icode</li><li>ifun</li><li>rA</li><li>rB</li><li>valC</li><li>valP</li><li>instr_valid</li><li>imem_error</li></ul><h4 id=译码--写回 class=headerLink><a href=#%e8%af%91%e7%a0%81--%e5%86%99%e5%9b%9e class=header-mark></a>2.7.2 译码 & 写回</h4><p>输入：</p><ul><li>icode</li><li>rA</li><li>rB</li><li>rsp（常量）</li></ul><p>输出：</p><ul><li>valA</li><li>valB</li></ul><h4 id=执行 class=headerLink><a href=#%e6%89%a7%e8%a1%8c class=header-mark></a>2.7.3 执行</h4><p>输入：</p><ul><li>icode</li><li>ifun</li><li>valA</li><li>valC</li><li>-8（常量）</li><li>8（常量）</li><li>valB</li><li>0（常量）</li></ul><p>输出：</p><ul><li>valE</li><li>Cnd</li></ul><h4 id=访存 class=headerLink><a href=#%e8%ae%bf%e5%ad%98 class=header-mark></a>2.7.4 访存</h4><p>输入：</p><ul><li>icode</li><li>valE</li><li>valA</li><li>valP</li><li>imem_error</li><li>instr_valid</li><li>dmem_error</li></ul><p>输出：</p><ul><li>Stat 状态码</li><li>valM</li></ul><h4 id=pc-更新 class=headerLink><a href=#pc-%e6%9b%b4%e6%96%b0 class=header-mark></a>2.7.5 PC 更新</h4><p>输入：</p><ul><li>icode</li><li>Cnd</li><li>valP</li><li>valC</li><li>valM</li></ul><p>输出：</p><ul><li>新的 PC</li></ul><blockquote><p>我们将以上所有阶段结构组合起来，即可构成我们的 Y86_64 顺序结构处理器。具体图像不再重复绘制。</p></blockquote><h2 id=流水线原理简介 class=headerLink><a href=#%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%8e%9f%e7%90%86%e7%ae%80%e4%bb%8b class=header-mark></a>3 流水线原理简介</h2><p>流水线将一个处理过程分解为多个阶段，可能有多个指令处于不同的处理阶段之中。流水线化的一个重要特性就是吞吐量，也就是单位时间内服务的顾客总数，不过它也会轻微的增加延迟，也就是服务一个用户所需要的时间。从头到尾执行一条指令所需要的时间称为延迟。</p><p>流水线化处理器将多个不同的阶段用寄存器分割，每个阶段用一个时钟周期的时间。每个阶段都是寄存器+组合逻辑，在时钟上升沿将该阶段组合逻辑计算出的值打入下一阶段寄存器。因此，运行时钟速率由最慢的那个阶段所决定。此外，如果流水线过深，效率可能反而会下降。</p><p>流水线的运行过程可能存在两种相关：数据相关和控制相关。数据相关多出现于下一条指令需要读入前一条指令写入的值。控制相关多出现于分支跳转，需要进行分支预测。</p><h2 id=流水线结构处理器-pipe-实现 class=headerLink><a href=#%e6%b5%81%e6%b0%b4%e7%ba%bf%e7%bb%93%e6%9e%84%e5%a4%84%e7%90%86%e5%99%a8-pipe-%e5%ae%9e%e7%8e%b0 class=header-mark></a>4 流水线结构处理器 PIPE-实现</h2><p>将前述 SEQ 顺序结构处理器的信号和值传递绘制成图可得到如下结构（省略所有常量，将所有阶段抽象化，省去写回逻辑和一些其他复杂逻辑，仅仅展示所用到的寄存器值）：</p><p><img class=tw-inline loading=lazy src=/ch4/abstract.png srcset="/ch4/abstract_hu_b2acfecfe143b263.webp 800w, /ch4/abstract_hu_391c1efd8a93c26b.webp 1200w, /ch4/abstract_hu_ef214a25585676e3.webp 1600w" alt=SEQ+ height=726 width=899></p><p>流水线结构处理器 PIPE-相对于顺序结构处理器 SEQ+的变化在于：</p><ul><li>将 PC 的计算移动到取指阶段</li><li>创建状态处理器来保存在一条指令执行过程中计算出来的信号</li><li>在各个阶段之间插入流水线寄存器<ul><li>F 保存程序计数器预测值</li><li>D 保存最新取出的指令信息，交给译码阶段进行处理</li><li>E 保存译码指令和从寄存器文件读出的值</li><li>M 保存指令执行结果，和用于条件转移的分支条件和分支目标信息</li><li>W 保存要向寄存器写入的值，还要向 PC 提供返回地址</li></ul></li></ul><p>在 PIPE-中，我们在译码阶段将 <code>valP</code> 和 <code>valA</code> 利用<code>Select A</code>模块合并成一个数据<code>valA</code>，以减少寄存器中字段的个数。</p><h2 id=包含冒险控制的流水线结构处理器-pipe-实现 class=headerLink><a href=#%e5%8c%85%e5%90%ab%e5%86%92%e9%99%a9%e6%8e%a7%e5%88%b6%e7%9a%84%e6%b5%81%e6%b0%b4%e7%ba%bf%e7%bb%93%e6%9e%84%e5%a4%84%e7%90%86%e5%99%a8-pipe-%e5%ae%9e%e7%8e%b0 class=header-mark></a>5 包含冒险控制的流水线结构处理器 PIPE 实现</h2><h3 id=控制冒险 class=headerLink><a href=#%e6%8e%a7%e5%88%b6%e5%86%92%e9%99%a9 class=header-mark></a>5.1 控制冒险</h3><p>控制冒险主要来源于 PC 的值不确定，需要对 PC 的值进行预测。在 Y86_64 架构中，PC 的值有以下几种可能：</p><ul><li><code>valP</code>: 正常的下一条指令。主要来源于<code>rrmovq,irmovq,OPq,rmmovq,mrmovq,pushq,popq</code></li><li><code>valC</code>: 跳转指令规定的特定指令地址。主要来源于<code>call</code></li><li><code>valM</code>: <code>ret</code>时的返回地址。主要来源于<code>ret</code></li></ul><p>此外，<code>jxx</code>指令的结果是<code>valC</code>还是<code>valP</code>需要视察<code>Cnd</code>而定。</p><p>因此：</p><ol><li>对于一般的指令，结合<code>icode</code>指令代码，PC 的值在取值阶段就可以确定。对于<code>call</code>指令是<code>valC</code>，对其他则是<code>valP</code></li><li>对于<code>ret</code>指令，PC 的值需要在访存阶段结束才能确定，其值为<code>valM</code>(存储在<code>W_valM</code>中)</li><li>对于<code>jxx</code>，需要在执行阶段产生<code>Cnd</code>信号后才能决定是否跳转，若跳转，其值为<code>valC</code>；否则为<code>valP</code>(存储在<code>M_valA</code>中)</li></ol><p>因此在设计中，我们采用的办法是，在取值阶段使用<code>Predict PC</code>模块来计算需要的是<code>valC</code>还是<code>valP</code>，将其结果存储到<code>F</code>取指寄存器中。在取指阶段开始之前，从<code>Predict PC</code>的结果，<code>valM</code>和<code>valE</code>中选择一个作为下一条指令的地址。</p><h3 id=数据冒险 class=headerLink><a href=#%e6%95%b0%e6%8d%ae%e5%86%92%e9%99%a9 class=header-mark></a>5.2 数据冒险</h3><p>Y86_64 指令集架构数据冒险的产生源于主要源于要读的值还没有完成更新。</p><p>冒险的来源可能是程序寄存器、程序计数器、内存、条件码寄存器和状态寄存器，我们来逐条分析他们产生冒险的可能性：</p><ol><li>程序寄存器：不同阶段的寄存器读写可能导致数据冒险</li><li>程序计数器(PC)：可能导致控制冒险</li><li>内存(Memory)：程序和数据分开读取，不允许自我修改代码，就不会发生冒险</li><li>条件码寄存器(CC)：不会发生冒险</li><li>状态寄存器(Stat)：让流水线中的每条指令都有一个相关联的状态码存储在寄存器中，就不会发生冒险</li></ol><p>综上，数据冒险仅仅来源于程序寄存器的读写。控制冒险主要来源于 PC 的正确预测问题。</p><p>数据冒险的解决方法有：</p><ol><li>用暂停避免数据冒险</li><li>用转发避免数据冒险</li><li>加载/使用数据冒险</li></ol><h4 id=用暂停避免数据冒险 class=headerLink><a href=#%e7%94%a8%e6%9a%82%e5%81%9c%e9%81%bf%e5%85%8d%e6%95%b0%e6%8d%ae%e5%86%92%e9%99%a9 class=header-mark></a>5.2.1 用暂停避免数据冒险</h4><p>暂停技术是指暂停流水线中的一条或多条指令，直到冒险条件不再满足。暂停时需要暂停一条或多条指令，将一条指令暂停在译码阶段也就意味着它的下一条指令必须暂停在取指阶段，暂停方法为让 PC 保持不变，一直重复取指，直到暂停结束，而其他阶段的暂停实现方法就是在执行阶段插入一个气泡。</p><p>暂停方法的劣势在于让流水线暂停多个周期，严重降低了整体的吞吐量。</p><h4 id=用转发避免数据冒险 class=headerLink><a href=#%e7%94%a8%e8%bd%ac%e5%8f%91%e9%81%bf%e5%85%8d%e6%95%b0%e6%8d%ae%e5%86%92%e9%99%a9 class=header-mark></a>5.2.2 用转发避免数据冒险</h4><p>执行阶段 ALU 计算出的数据，数据需要经过如下几个步骤才能到达写回寄存器：</p><ol><li>执行阶段输出（还未进入访存阶段寄存器）</li><li>执行阶段结果，进入访存阶段寄存器但无需访存(<code>valE</code>)</li><li>在访存阶段的访存结果(<code>valM</code>)</li><li>执行阶段结果，写回阶段寄存器中但还未写回(<code>W_valE</code>)</li><li>访存结果，写回阶段寄存器中但还未写回(<code>W_valM</code>)</li></ol><p>转发的核心在于将要读的值直接转发到<strong>执行阶段寄存器 E(在下一个时钟周期到来时才打入，所以根本来说是转发到译码阶段)</strong> 作为源操作数，其来源可能是：</p><ul><li>执行阶段的结果 -> 译码阶段(<code>e_valE</code>)</li><li>进入访存阶段但是无需访存的值 -> 译码阶段(<code>M_valE</code>)</li><li>进入写回阶段但是还没写回的值 -> 译码阶段(<code>W_valE</code>)</li><li>访存阶段读出的值 -> 译码阶段(<code>m_valM</code>)</li><li>访存读出的值已进入写回阶段但是还没写回 -> 译码阶段(<code>W_valM</code>)</li></ul><p>转发目的有两个，分别是<code>valA</code>和<code>valB</code>。</p><p>要实现转发逻辑，我们建立<code>Sel+Fwd A</code>和<code>Fwd B</code>两个块。<code>Sel+Fwd A</code>是<code>Select A</code>和转发逻辑的集合，我们前面学过<code>Select A</code>是从<code>valP</code>和<code>valA</code>中选择一个，<code>Fwd A</code>实现<code>valA</code>端口的转发逻辑，<code>Fwd B</code>实现<code>valB</code>端口的转发逻辑。</p><h4 id=加载使用数据冒险 class=headerLink><a href=#%e5%8a%a0%e8%bd%bd%e4%bd%bf%e7%94%a8%e6%95%b0%e6%8d%ae%e5%86%92%e9%99%a9 class=header-mark></a>5.2.3 加载/使用数据冒险</h4><p>该数据冒险的主要原因是读内存发生的太晚，譬如上一条指令需要从内存中读取<code>%rax</code>，下一条指令需要使用<code>%rax</code>，但是读内存在译码阶段后。对这种问题的解决方案是将暂停和转发结合起来，也就是在下一条指令前加上一个气泡。这种方式称为加载互锁，加载互锁和转发技术结合起来可以处理所有可能类型的数据冒险。代价是可能会降低流水线的吞吐量。</p><h3 id=避免控制冒险 class=headerLink><a href=#%e9%81%bf%e5%85%8d%e6%8e%a7%e5%88%b6%e5%86%92%e9%99%a9 class=header-mark></a>5.3 避免控制冒险</h3><p>控制冒险主要发生在<code>ret</code>指令和跳转指令。</p><p><code>ret</code>指令中，因为指令的地址需要在读内存后写回阶段写入<code>pc</code>，但是如果一个<code>call</code>指令紧接着一条<code>ret</code>指令的话，还不等到地址写入就会取指了，因此需要通过 3 个<code>nop</code>指令来让他暂停。</p><p>对于跳转指令，我们也是通过 2 个气泡同时取出跳转指令后的指令来取消预测错误的指令，但是会浪费几个时钟周期。</p><p>对基本是中的简单扩展就可以让我们暂停流水段，并向作为流水线控制逻辑的一部分呢流水线寄存器中插入气泡。</p><h2 id=异常处理 class=headerLink><a href=#%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86 class=header-mark></a>6 异常处理</h2><p>我们的指令集架构包含 3 种不同的异常：</p><ol><li><code>halt</code>指令</li><li>有非法指令和功能码组合的指令</li><li>取指或数据读写试图访问一个非法地址</li></ol><p>处理异常的基本原则是：由流水线中最深的指令引起的异常，优先级最高。</p><p>可能会出现两种特殊情况：</p><ol><li>导致异常的指令在后续被取消</li><li>后续的指令更改了异常状态</li></ol><p>我们的处理器面对异常的解决办法是在每个流水线寄存器中包括一个状态码 stat，如果某个阶段产生了一个异常，这个状态字段就被设置成指示异常的种类。异常状态和该指令的其他信息一起沿着流水线传播，直到它到达写回状态。再次，流水线控制逻辑发现出现了异常，并停止执行。</p><p>为了防止后续指令修改异常状态，当处于访存或写回阶段中的指令导致异常时，流水线控制逻辑必须禁止更新条件码寄存器或数据内存。</p><h2 id=pipe-各阶段实现 class=headerLink><a href=#pipe-%e5%90%84%e9%98%b6%e6%ae%b5%e5%ae%9e%e7%8e%b0 class=header-mark></a>7 PIPE 各阶段实现</h2><p>这里的信号相比 SEQ 阶段，进行了一些改动。例如译码寄存器 D 中读出的值为<code>D_valA</code>，而译码阶段产生的寄存器值为<code>d_valA</code>。详细设计不再赘述，具体如图。</p><h3 id=取指阶段-1 class=headerLink><a href=#%e5%8f%96%e6%8c%87%e9%98%b6%e6%ae%b5-1 class=header-mark></a>7.1 取指阶段</h3><p>取指阶段的工作是选择程序计数器的当前值，并且选择下一个 PC 值。PC 的下一条指令的地址有如下来源：</p><ul><li>条件跳转指令<code>jxx dest</code>(<code>dest</code>在<code>valC</code>中)，PC 的值为<code>valC</code>，要不要跳转需要等到执行阶段结束，<code>Cnd</code>信号产生后才能决定。如果<code>Cnd</code>为真，选择<code>valC</code>；否则选择<code>valP</code>。</li><li><code>ret</code>指令中需要从栈中返回一个地址(<code>valM</code>)，要在访存阶段结束才能决定</li><li><code>call dest</code>中调用的地址在<code>valC</code>中</li><li>其他情况下，下一条地址为<code>valP</code></li></ul><p>我们使用<code>Predict PC</code>来快速计算出 PC 的值，这里的下一条指令地址是可以立即预测出来的，也就是：</p><ol><li><code>call dest</code>，下一条指令地址为<code>valC</code></li><li><code>jxx dest</code>默认跳转，也就是下一条指令地址为<code>valC</code></li><li>其他情况，下一条指令地址为<code>valP</code></li></ol><p>总之，要么是<code>valC</code>，要么是<code>valP</code>，这需要根据<code>icode</code>来决定。这里我们默认跳转，也就是<code>jxx dest</code>的下一条指令是<code>valC</code>给定的地址，如果执行阶段给出的是不跳转，我们在<code>Select</code>单元中会对信号进行选择，对其进行矫正。</p><p>该阶段的<code>hcl</code>代码如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-14 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word f_predPC</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=k>f_icode</span> <span class=k>in</span> {<span class=k>IJXX</span><span class=p>,</span> <span class=k>ICALL</span>}<span class=err>:</span> <span class=k>f_valC</span><span class=err>;</span>
</span></span><span class=line><span class=cl>  <span class=m>1</span><span class=err>:</span> <span class=k>f_valP</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><p>不能立即预测出来的情况包括：</p><ol><li><code>jxx dest</code>：需要等到执行阶段才确定</li><li><code>ret</code>：需要等到访存阶段才确定</li></ol><p>此外，下一个 PC 的来源要么是访存阶段的<code>valM</code>(<code>ret</code>指令)，要么是执行阶段的<code>valA</code>(也就是<code>valP</code>,因为后面译码阶段对<code>valA</code>和<code>valP</code>进行了合并，<code>jxx dest</code>指令)。我们的设计是，在取指阶段使用一个<code>Select PC</code>控制单元，该控制单元接受写回阶段发来的<code>W_valM</code>和访存阶段发来的<code>M_valA</code>，对其进行选择。</p><p>那么<code>Select PC</code>控制逻辑有 3 个 PC 来源：</p><ol><li><code>f_predPC</code>：取指阶段的 PC 计算结果</li><li><code>W_valM</code>：访存阶段的 PC 计算结果（适用于<code>jxx</code>指令，由执行阶段的<code>Cnd</code>选择并写入访存阶段寄存器），在这一步对<code>jxx</code>指令跳转的下一条指令地址进行了校准</li><li><code>M_valA</code>：写回阶段的 PC 计算结果，适用于<code>ret</code>指令，该结果由访存阶段计算得到</li></ol><p>因此，<code>Select PC</code>控制逻辑的<code>hcl</code>代码为：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-15 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word f_pc</span> <span class=o>=</span> <span class=p>[</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Mispredicted branch. Fetch at incremented PC
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  M_icode</span> <span class=o>==</span> <span class=k>IJXX</span> <span class=err>&amp;&amp;</span> <span class=err>!</span><span class=k>M_Cnd</span><span class=err>:</span> <span class=k>M_valA</span><span class=err>;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # RET instruction returned
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  W_icode</span> <span class=o>==</span> <span class=k>IRET</span><span class=err>:</span> <span class=k>W_valM</span><span class=err>;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Default: Use predicted value of PC
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=m>1</span><span class=err>:</span> <span class=k>F_predPC</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><p>此外，我们还是需要计算出三个信号值：</p><ol><li><code>Instr Valid</code></li><li><code>Need Regids</code></li><li><code>Need ValC</code></li></ol><p>并且需要判断一下状态码：</p><ol><li><code>imem_error</code>是否产生</li><li><code>instr_valid</code></li><li>是否有<code>halt</code>指令</li></ol><p>其中，数据内存地址的有效性需要推迟到访存阶段才能检验。</p><p><img class=tw-inline loading=lazy src=/ch4/%E5%8F%96%E6%8C%87%E9%98%B6%E6%AE%B5.png srcset="/ch4/%E5%8F%96%E6%8C%87%E9%98%B6%E6%AE%B5_hu_c2dc78d3ced8827f.webp 800w, /ch4/%E5%8F%96%E6%8C%87%E9%98%B6%E6%AE%B5_hu_29a0927c9df79ce7.webp 1200w, /ch4/%E5%8F%96%E6%8C%87%E9%98%B6%E6%AE%B5_hu_9d6e6830342e06d4.webp 1600w" alt=取指 height=734 width=866></p><h3 id=译码及写回阶段 class=headerLink><a href=#%e8%af%91%e7%a0%81%e5%8f%8a%e5%86%99%e5%9b%9e%e9%98%b6%e6%ae%b5 class=header-mark></a>7.2 译码及写回阶段</h3><p>译码及写回阶段的重点在于<code>Sel+Fwd A</code>单元和<code>Fwd B</code>单元。</p><p><code>Sel+Fwd A</code>单元实现了：</p><ol><li><code>valA</code>和<code>valP</code>合并到<code>valA</code>：合并的原因是只有<code>call dest</code>和<code>jxx dest</code>需要用到<code>valP</code>，其他指令都是用<code>valA</code>，因此<code>valA</code>和<code>valP</code>不会同时使用，因此可以通过<code>Select A</code>进行合并，使用<code>icode</code>来进行控制。当<code>icode == ICALL或ICODE == JXX</code>，才选择<code>valP</code>。</li><li>选择<code>valA</code>的值来源<ol><li>转发来的</li><li>从<code>rA</code>中读取</li></ol></li></ol><p>我们在前文确定了转发的来源：</p><ul><li>执行阶段的结果 -> 译码阶段(<code>e_valE</code>)</li><li>进入访存阶段但是无需访存的值 -> 译码阶段(<code>M_valE</code>)</li><li>进入写回阶段但是还没写回的值 -> 译码阶段(<code>W_valE</code>)</li><li>访存阶段读出的值 -> 译码阶段(<code>m_valM</code>)</li><li>访存读出的值已进入写回阶段但是还没写回 -> 译码阶段(<code>W_valM</code>)</li></ul><p>我们需要对转发逻辑输入这些值以及其目的寄存器。因此一共 10 根线。我们需要比对转发源和输入寄存器的值（毕竟转发是因为该值还没有写入寄存器，但是时间上来不及了，因此不能让他读寄存器中的错误值，如果发现转发源和读寄存器的寄存器 ID 相同，就赶紧选择转发源，不要选<code>src</code>寄存器）。</p><p>信号合并+转发逻辑单元的<code>hcl</code>代码如下：</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-16 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word d_valA</span> <span class=o>=</span> <span class=p>[</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # 数据合并
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>D_icode</span> <span class=k>in</span> {<span class=k>ICALL</span><span class=p>,</span> <span class=k>IJXX</span>}<span class=err>:</span> <span class=k>D_valP</span><span class=err>;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # 转发实现
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  d_srcA</span> <span class=o>==</span> <span class=k>e_dstE</span><span class=err>:</span> <span class=k>e_valE</span><span class=err>;</span><span class=c1> # valE from execute
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  d_srcA</span> <span class=o>==</span> <span class=k>M_dstM</span><span class=err>:</span> <span class=k>m_valM</span><span class=err>;</span><span class=c1> # valM from memory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  d_srcA</span> <span class=o>==</span> <span class=k>M_dstE</span><span class=err>:</span> <span class=k>M_valE</span><span class=err>;</span><span class=c1> # valE from memory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  d_srcA</span> <span class=o>==</span> <span class=k>M_dstM</span><span class=err>:</span> <span class=k>W_valM</span><span class=err>;</span><span class=c1> # valM from write back
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  d_srcA</span> <span class=o>==</span> <span class=k>W_dstE</span><span class=err>:</span> <span class=k>W_valE</span><span class=err>;</span><span class=c1> # valE from write back
</span></span></span><span class=line><span class=cl><span class=c1>  # 其他情况下选择src寄存器
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=m>1</span><span class=err>:</span> <span class=k>d_rvalA</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><p>5 个转发源的优先级非常重要，因为转发源优先选择最近计算出的值（也就是执行阶段），流水线越浅处转发的值优先级越高。</p><p><code>Fwd B</code>单元实现了<code>valB</code>的值来源的选择。</p><p>写回阶段的状态<code>Stat</code>中需要考虑写回阶段有气泡的，这是正常操作的一部分，其他情况保持<code>Stat</code>的值不变，<code>hcl</code>描述如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-17 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>word Stat</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl><span class=n>  W_stat</span> <span class=o>==</span> <span class=k>SBUB</span><span class=err>:</span> <span class=k>SAOK</span><span class=err>;</span>
</span></span><span class=line><span class=cl>  <span class=m>1</span><span class=err>:</span> <span class=k>W_stat</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=p>]</span><span class=err>;</span></span></span></code></pre></div><p><img class=tw-inline loading=lazy src=/ch4/%E8%AF%91%E7%A0%81%E9%98%B6%E6%AE%B5.png srcset="/ch4/%E8%AF%91%E7%A0%81%E9%98%B6%E6%AE%B5_hu_5e3cff4432ac0881.webp 800w, /ch4/%E8%AF%91%E7%A0%81%E9%98%B6%E6%AE%B5_hu_9a395c9a531b4dc7.webp 1200w, /ch4/%E8%AF%91%E7%A0%81%E9%98%B6%E6%AE%B5_hu_78d0fd69413e964d.webp 1600w" alt=译码及写回 height=733 width=1021></p><h3 id=执行阶段-1 class=headerLink><a href=#%e6%89%a7%e8%a1%8c%e9%98%b6%e6%ae%b5-1 class=header-mark></a>7.3 执行阶段</h3><p><img class=tw-inline loading=lazy src=/ch4/%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5.png srcset="/ch4/%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5_hu_fa964541f14742ab.webp 800w, /ch4/%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5_hu_90bc34372a3b31d4.webp 1200w, /ch4/%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5_hu_934dca9f4e4b794c.webp 1600w" alt=执行阶段 height=468 width=840></p><h3 id=访存阶段-1 class=headerLink><a href=#%e8%ae%bf%e5%ad%98%e9%98%b6%e6%ae%b5-1 class=header-mark></a>7.4 访存阶段</h3><p><img class=tw-inline loading=lazy src=/ch4/%E8%AE%BF%E5%AD%98%E9%98%B6%E6%AE%B5.png srcset="/ch4/%E8%AE%BF%E5%AD%98%E9%98%B6%E6%AE%B5_hu_a20b127a80a17ab7.webp 800w, /ch4/%E8%AE%BF%E5%AD%98%E9%98%B6%E6%AE%B5_hu_a1dea88ceaa5d829.webp 1200w, /ch4/%E8%AE%BF%E5%AD%98%E9%98%B6%E6%AE%B5_hu_ec700dc1d90a7b24.webp 1600w" alt=访存阶段 height=478 width=759></p><h2 id=流水线控制逻辑 class=headerLink><a href=#%e6%b5%81%e6%b0%b4%e7%ba%bf%e6%8e%a7%e5%88%b6%e9%80%bb%e8%be%91 class=header-mark></a>8 流水线控制逻辑</h2><h3 id=几种特殊情况及其处理 class=headerLink><a href=#%e5%87%a0%e7%a7%8d%e7%89%b9%e6%ae%8a%e6%83%85%e5%86%b5%e5%8f%8a%e5%85%b6%e5%a4%84%e7%90%86 class=header-mark></a>8.1 几种特殊情况及其处理</h3><p>几种需要处理的特殊情况包括：</p><ul><li>加载/使用冒险：<ul><li>该冒险出现的情况是在下一条指令的译码阶段，上一条指令还没有完成访存</li><li>该冒险的处理方式是在访存指令后插入一个 bubble（暂停一个周期），然后再运行下一条指令</li></ul></li><li>处理 ret<ul><li>该冒险出现的情况是<code>ret</code>指令 PC 的下一条地址是在访存阶段完成，但是后面那条指令还不等到访存写入正确的 PC 就取指了，所以需要在<code>ret</code>后加 3 个 bubble（暂停 3 个周期）</li></ul></li><li>预测错误的分支<ul><li>该情况出现的原因是获取了错误的指令，那么我们需要在获取正确的指令前插入 bubble，并且将错误的指令改成<code>nop</code>（取消指令）</li></ul></li><li>异常<ul><li>异常的情况包括遇到了<code>halt</code>停机，取出了错误的指令，后续指令改变了之前的异常状态，我们需要做的是让指令的状态携带在寄存器中，随着指令的运行流过流水线，并且在遇到异常后停机（禁止后面的指令更新程序员可见的状态，并且在异常指令到达写回阶段的时候停止执行）</li></ul></li></ul><p>那么问题来了:</p><ol><li>如何发现异常？</li><li>如何插入 bubble？</li><li>如何暂停流水线？暂停有什么用？和插入 bubble 有什么区别？</li><li>如何将指令改为<code>nop</code>？将指令改为<code>nop</code>有什么用？</li><li>如何停机？</li><li>如何处理其他异常？</li></ol><h4 id=加载使用冒险处理 class=headerLink><a href=#%e5%8a%a0%e8%bd%bd%e4%bd%bf%e7%94%a8%e5%86%92%e9%99%a9%e5%a4%84%e7%90%86 class=header-mark></a>8.1.1 加载/使用冒险处理</h4><p>加载/使用冒险发生的时候，情况如下：</p><ol><li>该条指令在执行阶段</li><li>下一条指令在译码阶段，并且需要读这条指令访存的值</li></ol><p>我们的目标是：</p><ol><li>该条指令进入访存阶段</li><li>下一条指令依然在译码阶段</li><li>将值从访存阶段转发到下一条指令的译码阶段</li></ol><p>问题是：</p><ol><li>如何让该条指令进入访存阶段？</li><li>中间的执行阶段咋办？</li><li>如何让下一条指令保持在译码阶段？</li><li>如何让下一条指令也保持在取指阶段？</li></ol><p>我们的解决办法是：</p><ol><li>该条指令照常进行工作，在下一个周期进入访存阶段</li><li>在下个周期，在下一条指令和这条指令之间插入一个气泡，填充过执行阶段</li><li>让下一条指令暂停在译码阶段（流水线寄存器 D 保持固定）</li><li>下下一条指令暂停在取指阶段（流水线寄存器 F 保持固定）</li></ol><h4 id=ret指令处理 class=headerLink><a href=#ret%e6%8c%87%e4%bb%a4%e5%a4%84%e7%90%86 class=header-mark></a>8.1.2 <code>ret</code>指令处理</h4><p><code>ret</code>指令出现的时候，情况如下：</p><ol><li><code>ret</code>指令正在译码阶段</li><li>下一条指令正在取指阶段</li></ol><p>我们的目标是：等到<code>ret</code>指令进入写回阶段后，下一条指令在进入取指阶段</p><p>问题在于：<code>ret</code>指令从译码阶段到写回阶段需要 3 个时钟周期，在这期间如何保持下一条指令一直在取指阶段，且我们无法在取指阶段插入气泡</p><p>我们的解决办法是：</p><ol><li><code>ret</code>指令正常执行</li><li>取指阶段暂停，一直重复取出下一条指令</li><li>在<code>ret</code>执行到译码、执行、访存阶段时，将那些指令替换为气泡（<code>nop</code>）</li><li>3 个周期结束后继续取下一条指令</li></ol><h4 id=预测错误的分支处理 class=headerLink><a href=#%e9%a2%84%e6%b5%8b%e9%94%99%e8%af%af%e7%9a%84%e5%88%86%e6%94%af%e5%a4%84%e7%90%86 class=header-mark></a>8.1.3 预测错误的分支处理</h4><p>分支预测错误时，情况如下：</p><ol><li><code>jxx dest</code>指令位于译码阶段</li><li>下一条指令位于取指阶段</li></ol><p>我们的目标是：</p><ol><li>等到<code>jxx dest</code>进入访存阶段后，取下一条指令</li><li>其他时候取出的指令作废（包括译码阶段取指、执行阶段取指）</li></ol><p>实现的方法是：</p><ol><li><code>jxx dest</code>指令正常运作</li><li><code>jxx dest</code>在译码阶段、执行阶段中，处理器取出的指令替换为<code>nop</code>（执行阶段后才替换，因为<code>jxx dest</code>在执行阶段后才检测出错误来）</li><li>进入访存阶段后正常取出下一条指令</li></ol><h4 id=异常处理-1 class=headerLink><a href=#%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86-1 class=header-mark></a>8.1.4 异常处理</h4><p>对于异常，我们首先采取一个措施：在寄存器中加入<code>stat</code>状态字段，该字段随着指令流过寄存器。我们的目标是：异常前的指令正确执行，异常后的指令对程序可见的状态没有影响。</p><p>有 2 处位置会产生异常：</p><ol><li>取指，如果指令不合法或者指令地址不合法，会产生异常</li><li>访存，如果数据地址不合法，会产生异常</li></ol><p>程序状态在 3 个阶段被更新：</p><ol><li>执行</li><li>访存</li><li>写回</li></ol><p>我们应对这 3 个阶段的异常采取的措施是：</p><ol><li>禁止执行阶段中的指令设置条件码</li><li>像访存阶段中插入气泡</li><li>暂停写回阶段</li></ol><h3 id=发现特殊控制条件 class=headerLink><a href=#%e5%8f%91%e7%8e%b0%e7%89%b9%e6%ae%8a%e6%8e%a7%e5%88%b6%e6%9d%a1%e4%bb%b6 class=header-mark></a>8.2 发现特殊控制条件</h3><p>这里有几个问题：</p><ol><li>什么时候发现？</li><li>发现以后怎么做？</li></ol><p>几种情况：</p><ol><li>加载/使用冒险<ul><li>该条指令在执行阶段；下一条指令在译码阶段，并且需要读这条指令访存的值；</li><li><code>E_icode in {IMRMOVL,IPOPL} && E_dstM in {d_srcA,d_srcB}</code></li></ul></li><li>处理<code>ret</code>指令<ul><li>等待<code>ret</code>指令经过译码，执行，访存阶段，进入写回阶段</li><li><code>IRET in {D_icode, E_icode, M_icode}</code></li></ul></li><li>预测错误的分支<ul><li>该指令为<code>jxx dest</code>并且执行阶段<code>Cnd</code>为<code>false</code>(不跳转)</li><li><code>E_icode == IJXX && !e_Cnd</code></li></ul></li><li>异常情况<ul><li>检查访存和写回阶段的指令状态值，就能发现异常指令</li><li><code>m_stat in {SADR,SINS,SHLT} || W_stat in {SADR,SINS,SHLT}</code></li></ul></li></ol><h3 id=流水线控制机制 class=headerLink><a href=#%e6%b5%81%e6%b0%b4%e7%ba%bf%e6%8e%a7%e5%88%b6%e6%9c%ba%e5%88%b6 class=header-mark></a>8.3 流水线控制机制</h3><p>流水线的控制机制包括:</p><ol><li>暂停流水线</li><li>插入气泡（将下一条指令替换为<code>nop</code>）</li></ol><p>实现方式：对基本时钟寄存器进行一点小扩展，信号的设置决定在时钟上升沿如何更新流水线寄存器</p><ol><li>正常操作，两个输入都为 0，寄存器加载输入作为新状态</li><li>暂停信号为 1，禁止更新状态</li><li>气泡信号为 1，寄存器设置成某个固定的复位配置，得到一个等效于<code>nop</code>指令的状态</li><li>气泡和暂停都为 1，表明发生错误</li></ol><h3 id=流水线三种特殊情况下应该采取的行动 class=headerLink><a href=#%e6%b5%81%e6%b0%b4%e7%ba%bf%e4%b8%89%e7%a7%8d%e7%89%b9%e6%ae%8a%e6%83%85%e5%86%b5%e4%b8%8b%e5%ba%94%e8%af%a5%e9%87%87%e5%8f%96%e7%9a%84%e8%a1%8c%e5%8a%a8 class=header-mark></a>8.4 流水线三种特殊情况下应该采取的行动</h3><div class=table-wrapper><table><thead><tr><th style=text-align:>条件</th><th style=text-align:>F</th><th style=text-align:>D</th><th style=text-align:>E</th><th style=text-align:>M</th><th style=text-align:>W</th></tr></thead><tbody><tr><td style=text-align:>处理<code>ret</code></td><td style=text-align:>暂停</td><td style=text-align:>气泡</td><td style=text-align:>正常</td><td style=text-align:>正常</td><td style=text-align:>正常</td></tr><tr><td style=text-align:>加载/使用冒险</td><td style=text-align:>暂停</td><td style=text-align:>暂停</td><td style=text-align:>气泡</td><td style=text-align:>正常</td><td style=text-align:>正常</td></tr><tr><td style=text-align:>预测错误的分支</td><td style=text-align:>正常</td><td style=text-align:>气泡</td><td style=text-align:>气泡</td><td style=text-align:>正常</td><td style=text-align:>正常</td></tr></tbody></table></div><h3 id=控制条件的组合 class=headerLink><a href=#%e6%8e%a7%e5%88%b6%e6%9d%a1%e4%bb%b6%e7%9a%84%e7%bb%84%e5%90%88 class=header-mark></a>8.5 控制条件的组合</h3><h4 id=组合-ajxx-dest执行阶段--ret-指令译码阶段 class=headerLink><a href=#%e7%bb%84%e5%90%88-ajxx-dest%e6%89%a7%e8%a1%8c%e9%98%b6%e6%ae%b5--ret-%e6%8c%87%e4%bb%a4%e8%af%91%e7%a0%81%e9%98%b6%e6%ae%b5 class=header-mark></a>8.5.1 组合 A：JXX Dest（执行阶段) + ret 指令(译码阶段)</h4><p>冲突发生条件：</p><ol><li><code>jxx dest</code>在执行阶段计算出<code>Cnd</code>，发现跳转分支错误，于是选择在下一个时钟周期取消后面的 2 条指令</li><li><code>ret</code>指令进入到译码阶段，下一个周期进入执行阶段</li></ol><p>结果：<code>ret</code>指令被取消掉</p><p>但是<code>ret</code>指令进入执行阶段后，会让它后面的三条指令变成气泡（为了让<code>ret</code>顺利的度过访存阶段，取出下一条 PC），虽然<code>ret</code>被取消了，但是后面的 3 条指令还是暂停了。</p><p>最终方案：</p><ol><li><code>jxx dest</code>进入到访存阶段</li><li>进入到执行阶段的<code>ret</code>变成气泡</li><li>进入执行阶段的<code>ret</code>的后面一条指令（译码阶段）变成气泡</li><li>进入取指阶段的那条指令暂停，一直重复取指</li></ol><h4 id=组合-b加载使用冒险--ret-指令 class=headerLink><a href=#%e7%bb%84%e5%90%88-b%e5%8a%a0%e8%bd%bd%e4%bd%bf%e7%94%a8%e5%86%92%e9%99%a9--ret-%e6%8c%87%e4%bb%a4 class=header-mark></a>8.5.2 组合 B：加载/使用冒险 + ret 指令</h4><p>冲突发生条件：</p><ol><li>执行阶段存在一条访存指令（<code>mrmovq</code>或<code>popq</code>，推测多半是<code>popq</code>）</li><li>译码阶段是<code>ret</code>指令，刚好用到前面所用到的寄存器</li></ol><p>由于<code>ret</code>指令在译码阶段所用到的寄存器是<code>%rsp</code>，所以推测前面的那条指令是<code>popq %rsp</code>。那么也就是说：</p><ol><li><code>popq %rsp</code>位于执行阶段</li><li><code>ret</code>位于译码阶段</li></ol><p>对于<code>popq %rsp</code>造成的加载/使用冒险，当<code>popq %rsp</code>进入访存阶段时，<code>ret</code>进入执行阶段。为了应对加载/使用冒险，我们会在执行阶段插入一个气泡，将访存的结果转发到下一条指令的译码阶段，译码阶段和取指阶段暂停。</p><p>然而，当<code>ret</code>在译码阶段时会被检测到，当其进入执行阶段时，译码阶段的指令被转化为气泡，而取指阶段的指令暂停。</p><p>那么综合起来时间线如下：</p><ol><li><code>popq %rsp</code>位于执行阶段，加载/使用冒险被探测到；同时<code>ret</code>位于译码阶段，<code>ret</code>的处理被探测到</li><li><code>popq %rsp</code>进入访存阶段 -> 在执行阶段插入一个气泡，访存的结果被转发到下一条指令的译码阶段，译码阶段和取指阶段暂停；<code>ret</code>进入执行阶段 -> <code>ret</code>变成气泡，译码阶段变成气泡，取指阶段暂停；</li></ol><p>总结如下：</p><ol><li>执行阶段指令变成了气泡</li><li>取指阶段暂停</li></ol><p>那么冲突来了：译码阶段的指令到底是变成气泡呢？还是暂停呢？</p><blockquote><p>在 PIPE 的实现中，这里是存在问题的，它会在时钟里把气泡和暂停信号都设置为 1，我们希望它只采取针对加载/使用冒险的动作，处理<code>ret</code>指令的动作应该推迟一个周期。</p></blockquote><h3 id=控制逻辑实现 class=headerLink><a href=#%e6%8e%a7%e5%88%b6%e9%80%bb%e8%be%91%e5%ae%9e%e7%8e%b0 class=header-mark></a>8.6 控制逻辑实现</h3><blockquote><p>复习一下几种控制冒险的发生条件：</p><ol><li><p>加载/使用冒险</p><ul><li>该条指令在执行阶段；下一条指令在译码阶段，并且需要读这条指令访存的值；</li><li><code>E_icode in {IMRMOVL,IPOPL} && E_dstM in {d_srcA,d_srcB}</code></li></ul></li><li><p>处理<code>ret</code>指令</p><ul><li>等待<code>ret</code>指令经过译码，执行，访存阶段，进入写回阶段</li><li><code>IRET in {D_icode, E_icode, M_icode}</code></li></ul></li><li><p>预测错误的分支</p><ul><li>该指令为<code>jxx dest</code>并且执行阶段<code>Cnd</code>为<code>false</code>(不跳转)</li><li><code>E_icode == IJXX && !e_Cnd</code></li></ul></li><li><p>异常情况</p><ul><li>检查访存和写回阶段的指令状态值，就能发现异常指令</li><li><code>m_stat in {SADR,SINS,SHLT} || W_stat in {SADR,SINS,SHLT}</code></li></ul></li></ol></blockquote><p>要实现的控制逻辑如下：</p><ul><li><code>F_stall</code><ul><li>取指寄存器暂停主要存在于以下几种情况：<ul><li>加载/使用冒险</li><li>处理<code>ret</code></li></ul></li></ul></li><li><code>D_stall</code><ul><li>译码寄存器暂停主要存在于加载/使用冒险</li></ul></li><li><code>D_bubble</code><ul><li>译码寄存器插入气泡主要存在于以下几种情况：<ul><li>处理<code>ret</code></li><li>预测错误的分支</li></ul></li><li>此外，如前面组合 B 分析的，<strong>遇到加载/使用冒险<code>ret</code>指令组合的，不应该插入气泡</strong></li></ul></li><li><code>E_bubble</code><ul><li>执行阶段插入气泡主要存在于以下几种情况：<ul><li>加载/使用冒险</li><li>预测错误的分支</li></ul></li></ul></li><li><code>set_cc</code><ul><li>条件码的设置</li></ul></li><li><code>M_bubble</code><ul><li>访存阶段寄存器插入气泡主要存在于<strong>异常发生时</strong></li></ul></li><li><code>W_stall</code><ul><li>写回阶段寄存器暂停主要存在于<strong>异常发生时</strong></li></ul></li><li>其他的流水线控制信号都设置为 0</li></ul><p>各情况下的信号描述，和前文各控制冒险的探测条件相同。比如取指寄存器的暂停主要存在于加载/使用冒险和<code>ret</code>指令，那么其发生条件就是加载/使用冒险和<code>ret</code>指令的发生条件相或。</p><p>例如，<code>F_stall</code>的发生条件<code>hcl</code>描述如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-18 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>bool F_stall</span> <span class=o>=</span> <span class=p>[</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>	# 加载/使用冒险的条件
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>E_icode</span> <span class=k>in</span> {<span class=k>IMRMOVQ</span><span class=p>,</span><span class=k>IPOPQ</span>} <span class=err>&amp;&amp;</span> <span class=k>E_dstM</span> <span class=k>in</span> {<span class=k>d_srcA</span><span class=p>,</span> <span class=k>d_srcB</span>}
</span></span><span class=line><span class=cl>	<span class=err>||</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>	# ret指令通过流水线时暂停
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>IRET</span> <span class=k>in</span> {<span class=k>D_icode</span><span class=p>,</span> <span class=k>E_icode</span><span class=p>,</span> <span class=k>M_icode</span>}<span class=err>;</span>
</span></span><span class=line><span class=cl><span class=p>]</span><span class=err>;</span></span></span></code></pre></div><p><code>D_bubble</code>的发生条件<code>hcl</code>描述如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-19 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>bool D_bubble</span> <span class=o>=</span> <span class=p>[</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>	# 预测错误的分支
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>	(E_icode</span> <span class=o>==</span> <span class=k>IJXX</span> <span class=err>&amp;&amp;</span> <span class=err>!</span><span class=k>e_Cnd</span><span class=p>)</span> <span class=err>||</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>	# ret指令通过流水线时暂停
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>IRET</span> <span class=k>in</span> {<span class=k>D_icode</span><span class=p>,</span> <span class=k>E_icode</span><span class=p>,</span> <span class=k>M_icode</span>} <span class=err>&amp;&amp;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>	# 但是ret指令和加载/使用冒险不能同时出现
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=err>!</span><span class=p>(</span><span class=k>E_icode</span> <span class=k>in</span> {<span class=k>IMRMOVQ</span><span class=p>,</span> <span class=k>IPOPQ</span>} <span class=err>&amp;&amp;</span> <span class=k>E_dstM</span> <span class=k>in</span> {<span class=k>d_srcA</span><span class=p>,</span><span class=k>d_srcB</span>}<span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span><span class=err>;</span></span></span></code></pre></div><h3 id=两种测试方法 class=headerLink><a href=#%e4%b8%a4%e7%a7%8d%e6%b5%8b%e8%af%95%e6%96%b9%e6%b3%95 class=header-mark></a>8.7 两种测试方法</h3><ol><li>编写测试程序<ol><li><strong>基础指令</strong>测试，具有不同的源和目的寄存器</li><li><strong>跳转和函数调用</strong>指令测试，具有不同的是否选择分支的组合</li><li><strong>条件传送指令</strong>测试，具有不同控制组合</li><li><strong>数据冒险可能性</strong>测试，具有不同的源和目的组合，其中插入多种<code>nop</code>指令</li><li>不同<strong>数据冒险的控制组合</strong></li><li>导致<strong>异常的指令</strong>和其后可能改变程序员可见状态的指令组合</li></ol></li><li>使用形式化验证<ul><li>使用归纳法，表明两个处理器之间在一个周期到一个周期的基础上都是一致的</li><li>使用符号方法来推导硬件</li><li>能够证明 SEQ 和 PIPE 行为完全相同，但是不能保证都实现了完备的 Y86-64 体系结构</li></ul></li></ol><blockquote><p>可以使用 Verilog 语言来描述硬件，然后使用各种模拟和形式化工具进行测试验证，对设计有信心后，可以使用逻辑合成工具将设计翻译成实际的逻辑电路，最后下载到可编程门阵列（FPGA）上，运行实际的 Y86-64 程序。</p></blockquote><h2 id=性能分析 class=headerLink><a href=#%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90 class=header-mark></a>9 性能分析</h2><p>流水线中的暂停和气泡。都会导致流水线无法实现一个周期一条指令的目标，这里主要通过插入气泡的频率和个数来衡量效率的损失，因为插入气泡会导致未使用的流水线周期。不同指令插入气泡的情况如下：</p><ul><li>加载/使用冒险：插入 1 个气泡</li><li>跳转指令：插入 2 个气泡</li><li><code>ret</code>指令：插入 3 个气泡</li></ul><p>我们的衡量指标是 PIPE <strong>执行一条指令所需要的时钟周期数，也称为 CPI (Cycles Per Instructions), 该值是吞吐量的倒数</strong>。</p><p>我们的测试方法是在处理器上运行某个基准程序，其中计算 CPI 的公式如下：</p><p>$$
CPI = \frac{C_{i}+C_{b}}{C_{i}} = 1 + \frac{C_{b}}{C_{i}}
$$</p><p>其中$C_{i}$是执行的指令的个数，$C_{b}$是执行这些指令期间插入气泡的个数。如果没有气泡的话，应该是 1 个周期 1 条指令。但是有了气泡以后，就需要添加气泡所耗费的时钟周期（1 个气泡 1 个时钟周期）。因此</p><p>$$
CPI = 1 + (lp + mp + rp)
$$</p><p>我们可以将这个处罚项分解成 3 个部分：</p><ol><li>加载/使用冒险带来的气泡平均数 <code>lp</code></li><li>跳转指令所带来的气泡平均数 <code>mp</code></li><li><code>ret</code>指令所带来的气泡平均数 <code>rp</code></li></ol><p>要估算每个冒险产生的气泡平均数，需要：</p><ul><li>计算每条指令发生的频率</li><li>执行该指令时该冒险出现的频率</li><li>每次冒险产生的气泡个数</li></ul><blockquote><p>降低 CPI 的方法主要集中在预测错误的分支</p></blockquote><h2 id=未完成的工作 class=headerLink><a href=#%e6%9c%aa%e5%ae%8c%e6%88%90%e7%9a%84%e5%b7%a5%e4%bd%9c class=header-mark></a>10 未完成的工作</h2><h3 id=多周期指令 class=headerLink><a href=#%e5%a4%9a%e5%91%a8%e6%9c%9f%e6%8c%87%e4%bb%a4 class=header-mark></a>10.1 多周期指令</h3><p>复杂的指令需要多个周期才能完成。为了实现这些指令，我们需要：</p><ul><li>额外的硬件</li><li>协调这些指令的处理和正常流水线的机制</li></ul><p>实现有几种方法：</p><ol><li>简单的扩展执行阶段逻辑的功能：添加整数和浮点运算单元，在执行阶段多逗留，暂停后面的阶段（效率低下）</li><li>采用独立于主流水线的特殊硬件功能单元：译码阶段可以发射指令到特殊单元，主流水线继续执行后面的指令（并发执行）</li><li>不同单元的操作必须同步以避免出错：使用各种形式的转发</li></ol><h3 id=与存储系统的接口 class=headerLink><a href=#%e4%b8%8e%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f%e7%9a%84%e6%8e%a5%e5%8f%a3 class=header-mark></a>10.2 与存储系统的接口</h3><p>在对 PIPE 进行分析的时候，我们忽略了自我修改代码造成的可能冒险。也就是一个指令写，后面又要读。</p><p>但是，我们对存储器的引用是以虚拟地址的形式进行的，这要求在执行实际的读或写之前，要将虚拟地址翻译成物理地址，但是这需要很多个周期。而且，要读的数据可能在磁盘上，需要上百万个时钟周期才能完成。</p><p>而后我们会了解到，处理器的存储系统是由多种硬件存储器和管理虚拟内存的操作系统软件共同组成的。存储系统被组织成一个层次结构。最靠近处理器的一层是高速缓冲存储器(<code>cache</code>)。</p><p>一个典型的处理器有两个第一层高速缓存：一个用于读指令，一个用于读/写数据。此外，还有一种 cache，叫做翻译后备缓冲器(Translation Look-aside Buffer, 也叫 TLB)，它提供了从虚拟地址到物理地址的快速翻译。存储系统的快速访问是 TLB 和 cache 的共同作用，可能实现一个时钟周期内读或者写数据。</p><p>但是高速缓存也有不命中的可能。</p><ol><li>在较高层的存储系统中找到不命中的数据需要 3-20 个时钟周期。同时，流水线会简单暂停，将指令保持在取指或访问阶段，直到高速缓冲存储器能够执行读或写操作。</li><li>不命中的数据在磁盘上，此时硬件产生缺页异常信号，同其他异常一样，这个异常会导致处理器调用操作系统的异常处理程序代码。完成后操作系统返回到原来的程序，导致缺页的指令会被重新执行。因为访问磁盘需要上百万个时钟周期，因此缺页处理成顺序执行的上百个时钟周期数可以忽略不计。</li></ol><p>总结：</p><ol><li>用暂停处理短时间的高速缓存不命中</li><li>利用异常处理来处理长时间的缺页</li></ol><blockquote><p>微处理器结构发展：五级流水线 -> 超标量操作 —> 乱序发射/多核处理器等等</p></blockquote><h2 id=hcl-代码学习 class=headerLink><a href=#hcl-%e4%bb%a3%e7%a0%81%e5%ad%a6%e4%b9%a0 class=header-mark></a>11 HCL 代码学习</h2><p>PIPE 处理器的 HCL 代码<a href=http://csapp.cs.cmu.edu/3e/waside/waside-hcl.pdf target=_blank rel="noopener noreferrer">见此</a></p><p>HCL 是一种硬件描述语言，其含有对 Boolean 表达式的描述和一部分选择逻辑的描述，相比真正的 HDL 语言，还差了很多东西。HDL 语言主要通过一个叫<code>HCL2C</code>的程序转化成 C 语言程序，然后通过和其他一部分 C 程序相链接，形成最后的模拟器。</p><p>HCL 有两种信号：</p><ul><li>bool，翻译成 C 语言后是<code>int</code>类型，只有 0 和 1 两种值</li><li>int，翻译成 C 语言后是<code>long long int</code>类型</li></ul><h3 id=hcl-信号说明 class=headerLink><a href=#hcl-%e4%bf%a1%e5%8f%b7%e8%af%b4%e6%98%8e class=header-mark></a>11.1 HCL 信号说明</h3><p>信号的声明方式如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-20 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=k>boolsig</span> <span class=k>name</span> <span class=err>’</span><span class=k>C</span><span class=err>-</span><span class=k>expr</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>intsig</span> <span class=k>name</span> <span class=err>’</span><span class=k>C</span><span class=err>-</span><span class=k>expr</span><span class=err>’</span></span></span></code></pre></div><p>其中，信号名的命名方式为：字母/下划线+字母/数字/下划线，其中<code>C-expr</code>种可以是任意表达式，但是其中不能包含<code>’</code>和<code>\n</code>。<code>C-expr</code>会在编译时替换掉所有的<code>name</code></p><h3 id=hclquote class=headerLink><a href=#hclquote class=header-mark></a>11.2 HCL<code>quote</code></h3><p><code>quote</code>可以直接通过<code>hcl2c</code>传入 C 语言表达式，<code>’</code>内的字符串保持不变。（但是其中不能包含<code>’</code>和<code>\n</code>）</p><h3 id=hcl-表达式和块 class=headerLink><a href=#hcl-%e8%a1%a8%e8%be%be%e5%bc%8f%e5%92%8c%e5%9d%97 class=header-mark></a>11.3 HCL 表达式和块</h3><p>有两种表达式，<code>bool-expr</code>和<code>int-expr</code>。</p><p><code>bool-expr</code>的描述如图：</p><p><img class=tw-inline loading=lazy src=/ch4/bool-expr.png srcset="/ch4/bool-expr_hu_71abd578d13d7289.webp 800w, /ch4/bool-expr_hu_bea97586d59105bd.webp 1200w, /ch4/bool-expr_hu_ff5d411048e3c19e.webp 1600w" alt=bool-expr height=501 width=950></p><p>同一方框内的表达式的优先级相同。</p><p><code>int-expr</code>有 3 种：</p><ul><li><p>数字</p></li><li><p>命名的<code>intsig</code></p></li><li><p>case 表达式，其写法如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-21 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl><span class=k>bool</span><span class=err>-</span><span class=k>expr</span> <span class=m>1</span> <span class=err>:</span> <span class=k>int</span><span class=err>-</span><span class=k>expr</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>bool</span><span class=err>-</span><span class=k>expr</span> <span class=m>2</span> <span class=err>:</span> <span class=k>int</span><span class=err>-</span><span class=k>expr</span> <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=k>bool</span><span class=err>-</span><span class=k>expr</span> <span class=k>k</span> <span class=err>:</span> <span class=k>int</span><span class=err>-</span><span class=k>expr</span> <span class=k>k</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div></li></ul><p><code>expr</code>可以进行赋值，语句如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-22 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>bool name</span> <span class=o>=</span> <span class=k>bool</span><span class=err>-</span><span class=k>expr</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=n>int name</span> <span class=o>=</span> <span class=k>int</span><span class=err>-</span><span class=k>expr</span><span class=err>;</span></span></span></code></pre></div><h3 id=hcl-示例 class=headerLink><a href=#hcl-%e7%a4%ba%e4%be%8b class=header-mark></a>11.4 HCL 示例</h3><p>下面我们实现一个<code>MUX4</code>，其可以通过<code>hcl2c</code>和其他 C 程序结合运行，通过控制台输入参数，然后输出结果。</p><p><img class=tw-inline loading=lazy src=/ch4/mux4.png srcset="/ch4/mux4_hu_5d4fa782adf80187.webp 800w, /ch4/mux4_hu_b642aba3e39588fd.webp 1200w, /ch4/mux4_hu_666e4ec54c2e237e.webp 1600w" alt=mux4 height=248 width=415></p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-23 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>  <span class=k>quote</span> <span class=err>’</span><span class=c1>#include &lt;stdio.h&gt;’
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>quote</span> <span class=err>’</span><span class=c1>#include &lt;stdlib.h&gt;’
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>quote</span> <span class=err>’</span><span class=k>long</span> <span class=k>long</span> <span class=k>code_val</span><span class=p>,</span> <span class=k>s0_val</span><span class=p>,</span> <span class=k>s1_val</span><span class=err>;’</span>
</span></span><span class=line><span class=cl>  <span class=k>quote</span> <span class=err>’</span><span class=k>char</span> <span class=err>**</span><span class=k>data_names</span><span class=err>;’</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  ## Declarations of signals used in the HCL description and
</span></span></span><span class=line><span class=cl><span class=c1>  ## the corresponding C expressions.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>boolsig</span> <span class=k>s0</span> <span class=err>’</span><span class=k>s0_val</span><span class=err>’</span>
</span></span><span class=line><span class=cl>  <span class=k>boolsig</span> <span class=k>s1</span> <span class=err>’</span><span class=k>s1_val</span><span class=err>’</span>
</span></span><span class=line><span class=cl>  <span class=k>wordsig</span> <span class=k>code</span> <span class=err>’</span><span class=k>code_val</span><span class=err>’</span>
</span></span><span class=line><span class=cl>  <span class=k>wordsig</span> <span class=k>A</span> <span class=err>’</span><span class=k>atoll</span><span class=p>(</span><span class=k>data_names</span><span class=p>[</span><span class=m>0</span><span class=p>])</span><span class=err>’</span>
</span></span><span class=line><span class=cl>  <span class=k>wordsig</span> <span class=k>B</span> <span class=err>’</span><span class=k>atoll</span><span class=p>(</span><span class=k>data_names</span><span class=p>[</span><span class=m>1</span><span class=p>])</span><span class=err>’</span>
</span></span><span class=line><span class=cl>  <span class=k>wordsig</span> <span class=k>C</span> <span class=err>’</span><span class=k>atoll</span><span class=p>(</span><span class=k>data_names</span><span class=p>[</span><span class=m>2</span><span class=p>])</span><span class=err>’</span>
</span></span><span class=line><span class=cl>  <span class=k>wordsig</span> <span class=k>D</span> <span class=err>’</span><span class=k>atoll</span><span class=p>(</span><span class=k>data_names</span><span class=p>[</span><span class=m>3</span><span class=p>])</span><span class=err>’</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  ## HCL descriptions of the logic blocks
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  bool s1</span> <span class=o>=</span> <span class=k>code</span> <span class=k>in</span> { <span class=m>2</span><span class=p>,</span> <span class=m>3</span> }<span class=err>;</span>
</span></span><span class=line><span class=cl><span class=n>  bool s0</span> <span class=o>=</span> <span class=k>code</span> <span class=k>in</span> { <span class=m>1</span><span class=p>,</span> <span class=m>3</span> }<span class=err>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  word Out4</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=err>!</span><span class=k>s1</span> <span class=err>&amp;&amp;</span> <span class=err>!</span><span class=k>s0</span> <span class=err>:</span> <span class=k>A</span><span class=err>;</span><span class=c1> # 00
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=err>!</span><span class=k>s1</span> <span class=err>:</span> <span class=k>B</span><span class=err>;</span><span class=c1> # 01
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=err>!</span><span class=k>s0</span> <span class=err>:</span> <span class=k>C</span><span class=err>;</span><span class=c1> # 10
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=m>1</span> <span class=err>:</span> <span class=k>D</span><span class=err>;</span><span class=c1> # 11
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>]</span><span class=err>;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  ## More information inserted verbatim into the C code to
</span></span></span><span class=line><span class=cl><span class=c1>  ## compute the values and print the output
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>quote</span> <span class=err>’</span><span class=k>int</span> <span class=k>main</span><span class=p>(</span><span class=k>int</span> <span class=k>argc</span><span class=p>,</span> <span class=k>char</span> <span class=err>*</span><span class=k>argv</span><span class=p>[])</span> {<span class=err>’</span>
</span></span><span class=line><span class=cl><span class=n>  quote ’ data_names</span> <span class=o>=</span> <span class=k>argv</span><span class=err>+</span><span class=m>2</span><span class=err>;’</span>
</span></span><span class=line><span class=cl><span class=n>  quote ’ code_val</span> <span class=o>=</span> <span class=k>atoll</span><span class=p>(</span><span class=k>argv</span><span class=p>[</span><span class=m>1</span><span class=p>])</span><span class=err>;’</span>
</span></span><span class=line><span class=cl><span class=n>  quote ’ s1_val</span> <span class=o>=</span> <span class=k>gen_s1</span><span class=p>()</span><span class=err>;’</span>
</span></span><span class=line><span class=cl><span class=n>  quote ’ s0_val</span> <span class=o>=</span> <span class=k>gen_s0</span><span class=p>()</span><span class=err>;’</span>
</span></span><span class=line><span class=cl><span class=n>  quote ’ printf(&#34;Out</span> <span class=o>=</span> <span class=err>%</span><span class=k>lld</span><span class=err>\</span><span class=k>n</span><span class=err>&#34;</span><span class=p>,</span> <span class=k>gen_Out4</span><span class=p>())</span><span class=err>;’</span>
</span></span><span class=line><span class=cl>  <span class=k>quote</span> <span class=err>’</span> <span class=k>return</span> <span class=m>0</span><span class=err>;’</span>
</span></span><span class=line><span class=cl>  <span class=k>quote</span> <span class=err>’</span>}<span class=err>’</span></span></span></code></pre></div><p>这个代码可以分为如下几个部分：</p><ul><li>头文件的引入和信号的定义<ul><li><code>long long</code>类型的<code>code_val, s0_val, s1_val</code></li><li><code>char**</code>的字符串数组<code>data_names</code></li><li>声明各个信号：<code>s0 s1 code A B C D</code></li></ul></li><li>信号的求值<ul><li><code>s0</code>和<code>s1</code>由<code>code</code>的值得出</li></ul></li><li>控制逻辑的实现<ul><li><code>Out4</code>的结果值由<code>s0 s1 A B C D</code>共同得出</li></ul></li><li>C 语言程序的嵌入<ul><li>上述<code>hcl</code>代码会被转化成<code>gen_S1()</code>，<code>gen_S0()</code>，<code>gen_Out4()</code>等</li></ul></li></ul><h3 id=hcl-seq-代码分析 class=headerLink><a href=#hcl-seq-%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90 class=header-mark></a>11.5 HCL SEQ 代码分析</h3><h4 id=头文件引入 class=headerLink><a href=#%e5%a4%b4%e6%96%87%e4%bb%b6%e5%bc%95%e5%85%a5 class=header-mark></a>11.5.1 头文件引入</h4><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-24 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=k>quote</span> <span class=err>’</span><span class=c1>#include &lt;stdio.h&gt;’
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>quote</span> <span class=err>’</span><span class=c1>#include &#34;isa.h&#34;’
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>quote</span> <span class=err>’</span><span class=c1>#include &#34;sim.h&#34;’
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>quote</span> <span class=err>’</span><span class=k>int</span> <span class=k>sim_main</span><span class=p>(</span><span class=k>int</span> <span class=k>argc</span><span class=p>,</span> <span class=k>char</span> <span class=err>*</span><span class=k>argv</span><span class=p>[])</span><span class=err>;’</span>
</span></span><span class=line><span class=cl><span class=k>quote</span> <span class=err>’</span><span class=k>word_t</span> <span class=k>gen_pc</span><span class=p>()</span>{<span class=k>return</span> <span class=m>0</span><span class=err>;</span>}<span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>quote</span> <span class=err>’</span><span class=k>int</span> <span class=k>main</span><span class=p>(</span><span class=k>int</span> <span class=k>argc</span><span class=p>,</span> <span class=k>char</span> <span class=err>*</span><span class=k>argv</span><span class=p>[])</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=n>quote ’ {plusmode</span><span class=o>=</span><span class=m>0</span><span class=err>;</span><span class=k>return</span> <span class=k>sim_main</span><span class=p>(</span><span class=k>argc</span><span class=p>,</span><span class=k>argv</span><span class=p>)</span><span class=err>;</span>}<span class=err>’</span></span></span></code></pre></div><p>这段代码主要使用<code>quote</code>来嵌入 C 语言程序，可以看到其中包含了如下函数：</p><ul><li><code>main</code>函数：设置<code>plusmode = 0</code>，返回<code>sim_main(argc,argv)</code>的结果（目测<code>plusmode</code>可能是流水线的设置模式，主要的模拟在<code>sim_main</code>种进行）</li><li><code>sim_main</code>：模拟函数</li><li><code>gen_pc</code>：返回 PC 的值</li></ul><h4 id=信号声明 class=headerLink><a href=#%e4%bf%a1%e5%8f%b7%e5%a3%b0%e6%98%8e class=header-mark></a>11.5.2 信号声明</h4><p>信号有如下几种：</p><ul><li><p>指令代码</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-25 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1>##### Symbolic representation of Y86-64 Instruction Codes #############
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>INOP</span> <span class=err>’</span><span class=k>I_NOP</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>wordsig</span> <span class=k>IHALT</span> <span class=err>’</span><span class=k>I_HALT</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>wordsig</span> <span class=k>IRRMOVQ</span> <span class=err>’</span><span class=k>I_RRMOVQ</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>wordsig</span> <span class=k>IIRMOVQ</span> <span class=err>’</span><span class=k>I_IRMOVQ</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>wordsig</span> <span class=k>IRMMOVQ</span> <span class=err>’</span><span class=k>I_RMMOVQ</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>wordsig</span> <span class=k>IMRMOVQ</span> <span class=err>’</span><span class=k>I_MRMOVQ</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>wordsig</span> <span class=k>IOPQ</span> <span class=err>’</span><span class=k>I_ALU</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>wordsig</span> <span class=k>IJXX</span> <span class=err>’</span><span class=k>I_JMP</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>wordsig</span> <span class=k>ICALL</span> <span class=err>’</span><span class=k>I_CALL</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>wordsig</span> <span class=k>IRET</span> <span class=err>’</span><span class=k>I_RET</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>wordsig</span> <span class=k>IPUSHQ</span> <span class=err>’</span><span class=k>I_PUSHQ</span><span class=err>’</span>
</span></span><span class=line><span class=cl><span class=k>wordsig</span> <span class=k>IPOPQ</span> <span class=err>’</span><span class=k>I_POPQ</span><span class=err>’</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>##### Symbolic represenations of Y86-64 function codes #####
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>FNONE</span> <span class=err>’</span><span class=k>F_NONE</span><span class=err>’</span> <span class=err>#</span> <span class=k>Default</span> <span class=k>function</span> <span class=k>code</span></span></span></code></pre></div></li><li><p>要用到的特殊寄存器</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-26 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1>##### Symbolic representation of Y86-64 Registers referenced explicitly #####
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>RRSP</span> <span class=err>’</span><span class=k>REG_RSP</span><span class=err>’</span><span class=c1> # Stack Pointer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>RNONE</span> <span class=err>’</span><span class=k>REG_NONE</span><span class=err>’</span> <span class=err>#</span> <span class=k>Special</span> <span class=k>value</span> <span class=k>indicating</span> <span class=s2>&#34;no register&#34;</span></span></span></code></pre></div></li><li><p>要用到的加法</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-27 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1>##### ALU Functions referenced explicitly #####
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>ALUADD</span> <span class=err>’</span><span class=k>A_ADD</span><span class=err>’</span> <span class=err>#</span> <span class=k>ALU</span> <span class=k>should</span> <span class=k>add</span> <span class=k>its</span> <span class=k>arguments</span></span></span></code></pre></div></li><li><p>状态代码</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-28 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1>##### Possible instruction status values #####
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>SAOK</span> <span class=err>’</span><span class=k>STAT_AOK</span><span class=err>’</span><span class=c1> # Normal execution
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>SADR</span> <span class=err>’</span><span class=k>STAT_ADR</span><span class=err>’</span><span class=c1> # Invalid memory address
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>SINS</span> <span class=err>’</span><span class=k>STAT_INS</span><span class=err>’</span><span class=c1> # Invalid instruction
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>SHLT</span> <span class=err>’</span><span class=k>STAT_HLT</span><span class=err>’</span> <span class=err>#</span> <span class=k>Halt</span> <span class=k>instruction</span> <span class=k>encountered</span></span></span></code></pre></div></li><li><p>各阶段信号</p><ul><li>取指阶段信号</li></ul><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-29 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1>##### Fetch stage inputs #####
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>pc</span> <span class=err>’</span><span class=k>pc</span><span class=err>’</span><span class=c1> # Program counter
</span></span></span><span class=line><span class=cl><span class=c1>##### Fetch stage computations #####
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>imem_icode</span> <span class=err>’</span><span class=k>imem_icode</span><span class=err>’</span><span class=c1> # icode field from instruction memory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>imem_ifun</span> <span class=err>’</span><span class=k>imem_ifun</span><span class=err>’</span><span class=c1> # ifun field from instruction memory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>icode</span> <span class=err>’</span><span class=k>icode</span><span class=err>’</span><span class=c1> # Instruction control code
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>ifun</span> <span class=err>’</span><span class=k>ifun</span><span class=err>’</span><span class=c1> # Instruction function
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>rA</span> <span class=err>’</span><span class=k>ra</span><span class=err>’</span><span class=c1> # rA field from instruction
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>rB</span> <span class=err>’</span><span class=k>rb</span><span class=err>’</span><span class=c1> # rB field from instruction
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>valC</span> <span class=err>’</span><span class=k>valc</span><span class=err>’</span><span class=c1> # Constant from instruction
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>valP</span> <span class=err>’</span><span class=k>valp</span><span class=err>’</span><span class=c1> # Address of following instruction
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>boolsig</span> <span class=k>imem_error</span> <span class=err>’</span><span class=k>imem_error</span><span class=err>’</span><span class=c1> # Error signal from instruction memory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>boolsig</span> <span class=k>instr_valid</span> <span class=err>’</span><span class=k>instr_valid</span><span class=err>’</span> <span class=err>#</span> <span class=k>Is</span> <span class=k>fetched</span> <span class=k>instruction</span> <span class=k>valid</span><span class=err>?</span></span></span></code></pre></div><ul><li>译码 & 写回阶段信号</li></ul><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-30 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1>##### Decode stage computations #####
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>valA</span> <span class=err>’</span><span class=k>vala</span><span class=err>’</span><span class=c1> # Value from register A port
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>valB</span> <span class=err>’</span><span class=k>valb</span><span class=err>’</span> <span class=err>#</span> <span class=k>Value</span> <span class=k>from</span> <span class=k>register</span> <span class=k>B</span> <span class=k>port</span></span></span></code></pre></div><ul><li>执行阶段信号</li></ul><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-31 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1>##### Execute stage computations #####
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>valE</span> <span class=err>’</span><span class=k>vale</span><span class=err>’</span><span class=c1> # Value computed by ALU
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>boolsig</span> <span class=k>Cnd</span> <span class=err>’</span><span class=k>cond</span><span class=err>’</span> <span class=err>#</span> <span class=k>Branch</span> <span class=k>test</span></span></span></code></pre></div><ul><li>访存阶段信号</li></ul><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">hcl</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-32 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1>##### Memory stage computations #####
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>wordsig</span> <span class=k>valM</span> <span class=err>’</span><span class=k>valm</span><span class=err>’</span><span class=c1> # Value read from memory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>boolsig</span> <span class=k>dmem_error</span> <span class=err>’</span><span class=k>dmem_error</span><span class=err>’</span> <span class=err>#</span> <span class=k>Error</span> <span class=k>signal</span> <span class=k>from</span> <span class=k>data</span> <span class=k>memory</span></span></span></code></pre></div></li></ul><p>剩下几个阶段的<code>hcl</code>代码在前文已经写过了，这里不再解释。</p><h3 id=hcl-pipe-代码分析 class=headerLink><a href=#hcl-pipe-%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90 class=header-mark></a>11.6 HCL PIPE 代码分析</h3><p>剩下几个阶段的<code>hcl</code>代码在前文已经写过了，这里不再解释。</p><h2 id=verlog-代码学习 class=headerLink><a href=#verlog-%e4%bb%a3%e7%a0%81%e5%ad%a6%e4%b9%a0 class=header-mark></a>12 Verlog 代码学习</h2><p>PIPE 处理器的 Verilog 代码<a href=http://csapp.cs.cmu.edu/3e/waside/waside-verilog.pdf target=_blank rel="noopener noreferrer">见此</a></p><h2 id=总结 class=headerLink><a href=#%e6%80%bb%e7%bb%93 class=header-mark></a>13 总结</h2><p>在本章中，我们：</p><ol><li>简单介绍了 CISC 和 RISC 指令集的区别，并设计了一个汇集二者特性的 Y86-64 指令集</li><li>分析 Y86-64 指令集，构造了 SEQ 顺序结构处理器</li><li>将顺序结构处理器 PC 更新阶段调整到开头，生成了 SEQ+处理器</li><li>添加流水线寄存器，生成 PIPE-流水线处理器</li><li>添加转发逻辑，生成 PIPE 流水线处理器</li><li>添加异常处理机制，并描述了各控制信号</li></ol><p>实现心得：</p><ol><li>管理复杂性</li><li>不需要直接实现 ISA，而是将其抽象为五个阶段</li><li>设计时必须小心分析，仔细分析各个指令的组合，并进行详尽的测试</li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2025-03-21</span></div><div class=post-info-license></div></div><div class="post-info-line print:!tw-hidden"><div class=post-info-md><span><a class=link-to-mardown href=/ch4/index.md target=_blank rel="noopener noreferrer">阅读原始文档</a>
</span><span>|&nbsp;<a class=link-to-source href=https://github.com/HEIGE-PCloud/DoIt/blob/main/exampleSite/content/posts/cs/系统入门/15-213/CSAPP 阅读笔记/ch4/index.md target=_blank rel="noopener noreferrer">查看源代码</a>
</span><span>|&nbsp;<a class=link-to-edit href=https://github.com/HEIGE-PCloud/DoIt/edit/main/exampleSite/content/posts/cs/系统入门/15-213/CSAPP 阅读笔记/ch4/index.md target=_blank rel="noopener noreferrer">编辑此页</a>
</span><span>|&nbsp;<a class=link-to-report href="https://github.com/HEIGE-PCloud/DoIt/issues/new?title=[bug]%20CSAPP+Chapter+4+-+%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84&body=|Field|Value|%0A|-|-|%0A|Title|CSAPP+Chapter+4+-+%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84|%0A|Url|https://salvely.github.io/ch4/|%0A|Filename|https://github.com/HEIGE-PCloud/DoIt/blob/main/exampleSite/content/posts/cs/系统入门/15-213/CSAPP" 阅读笔记/ch4/index.md| target=_blank rel="noopener noreferrer">报告问题</a></span></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=https://salvely.github.io/ch4/ data-title="CSAPP Chapter 4 - 处理器体系结构"><svg class="icon" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></button><button title="分享到 Facebook" data-sharer=facebook data-url=https://salvely.github.io/ch4/><svg class="icon" viewBox="0 0 512 512"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></button><button title="分享到 Hacker News" data-sharer=hackernews data-url=https://salvely.github.io/ch4/ data-title="CSAPP Chapter 4 - 处理器体系结构"><svg class="icon" viewBox="0 0 448 512"><path d="M0 32v448h448V32H0zm21.2 197.2H21c.1-.1.2-.3.3-.4.0.1.0.3-.1.4zm218 53.9V384h-31.4V281.3L128 128h37.3c52.5 98.3 49.2 101.2 59.3 125.6 12.3-27 5.8-24.4 60.6-125.6H320l-80.8 155.1z"/></svg></button><button title="分享到 Line" data-sharer=line data-url=https://salvely.github.io/ch4/ data-title="CSAPP Chapter 4 - 处理器体系结构"><svg class="icon" role="img" viewBox="0 0 24 24"><title>LINE</title><path d="M19.365 9.863c.349.0.63.285.63.631.0.345-.281.63-.63.63H17.61v1.125h1.755c.349.0.63.283.63.63.0.344-.281.629-.63.629h-2.386c-.345.0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346.0.627.285.627.63.0.349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211.0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346.0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195.0.375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345.0.63.285.63.63v4.771zm-5.741.0c0 .344-.282.629-.631.629-.345.0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346.0.628.285.628.63v4.771zm-2.466.629H4.917c-.345.0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348.0.63.285.63.63v4.141h1.756c.348.0.629.283.629.63.0.344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943.0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg></button><button title="分享到 微博" data-sharer=weibo data-url=https://salvely.github.io/ch4/ data-title="CSAPP Chapter 4 - 处理器体系结构"><svg class="icon" viewBox="0 0 512 512"><path d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7.0 395.3.0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"/></svg></button><button title="分享到 Telegram" data-sharer=telegram data-url=https://salvely.github.io/ch4/ data-title="CSAPP Chapter 4 - 处理器体系结构" data-web><svg class="icon" viewBox="0 0 448 512"><path d="M446.7 98.6l-67.6 318.8c-5.1 22.5-18.4 28.1-37.3 17.5l-103-75.9-49.7 47.8c-5.5 5.5-10.1 10.1-20.7 10.1l7.4-104.9 190.9-172.5c8.3-7.4-1.8-11.5-12.9-4.1L117.8 284 16.2 252.2c-22.1-6.9-22.5-22.1 4.6-32.7L418.2 66.4c18.4-6.9 34.5 4.1 28.5 32.2z"/></svg></button><script>function shareOnMastodon(e,t){const o="share_mastodon_domain",i=localStorage.getItem(o)??"mastodon.social",n=prompt("Enter your Mastodon domain",i);if(n===null)return;localStorage.setItem(o,n);const a=e+`

`+t,s=new URL("https://"+n);s.pathname="share",s.searchParams.append("text",a),window.open(s,"_blank","width=500,height=500,left=500,toolbar=0,status=0")}</script>
<button title="分享到 Mastodon" onclick='shareOnMastodon("CSAPP Chapter 4 - 处理器体系结构","https://salvely.github.io/ch4/")'><svg class="icon" viewBox="0 0 448 512"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></button></div></div></div><div class=post-info-more><section class=post-tags></section><section class=print:!tw-hidden><span><button class="tw-text-fgColor-link-muted hover:tw-text-fgColor-link-muted-hover" onclick=window.history.back()>返回</button></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class="post-nav print:tw-hidden"><a href=/attack-lab-recitation/ class=prev rel=prev title="Attack lab recitation"><svg class="icon" viewBox="0 0 256 512"><path d="M31.7 239l136-136c9.4-9.4 24.6-9.4 33.9.0l22.6 22.6c9.4 9.4 9.4 24.6.0 33.9L127.9 256l96.4 96.4c9.4 9.4 9.4 24.6.0 33.9L201.7 409c-9.4 9.4-24.6 9.4-33.9.0l-136-136c-9.5-9.4-9.5-24.6-.1-34z"/></svg>Attack lab recitation</a>
<a href=/arch-lab%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/ class=next rel=next title="Arch Lab实验总结">Arch Lab实验总结<svg class="icon" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9.0l-22.6-22.6c-9.4-9.4-9.4-24.6.0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6.0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9.0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></a></div></div><div id=comments class="print:!tw-hidden tw-pt-32 tw-pb-8"><div id=giscus></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/>giscus</a>.</noscript></div></article></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.145.0">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><svg class="icon" viewBox="0 0 576 512"><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1.0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7.0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174 402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7-43.2-43.2c-4.1-4.1-10.8-4.1-14.8.0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg> DoIt</a></div><div class=footer-line><svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 448c-110.532.0-2e2-89.451-2e2-2e2.0-110.531 89.451-2e2 2e2-2e2 110.532.0 2e2 89.451 2e2 2e2.0 110.532-89.451 2e2-2e2 2e2zm107.351-101.064c-9.614 9.712-45.53 41.396-104.065 41.396-82.43.0-140.484-61.425-140.484-141.567.0-79.152 60.275-139.401 139.762-139.401 55.531.0 88.738 26.62 97.593 34.779a11.965 11.965.0 011.936 15.322l-18.155 28.113c-3.841 5.95-11.966 7.282-17.499 2.921-8.595-6.776-31.814-22.538-61.708-22.538-48.303.0-77.916 35.33-77.916 80.082.0 41.589 26.888 83.692 78.277 83.692 32.657.0 56.843-19.039 65.726-27.225 5.27-4.857 13.596-4.039 17.82 1.738l19.865 27.17a11.947 11.947.0 01-1.152 15.518z"/></svg>2024 - 2025<span class=author>&nbsp;<a href=https://github.com/Salvely target=_blank rel="noopener noreferrer">Salvely</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer><div class="print:!tw-hidden tw-flex tw-flex-col tw-fixed tw-right-4 tw-bottom-4 tw-gap-2"><a href=#back-to-top id=back-to-top-button class="tw-transition-opacity tw-opacity-0 tw-block tw-bg-bgColor-secondary tw-rounded-full" style=padding:.6rem;line-height:1.3rem;font-size:1rem title=回到顶部><svg class="icon" viewBox="0 0 448 512"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg>
</a><button id=toc-drawer-button class="tw-block tw-bg-bgColor-secondary tw-rounded-full md:tw-hidden" style=padding:.6rem;line-height:1.3rem;font-size:1rem>
<svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg>
</button><a href=#comments id=view-comments class="tw-block tw-bg-bgColor-secondary tw-rounded-full" style=padding:.6rem;line-height:1.3rem;font-size:1rem title=查看评论><svg class="icon" viewBox="0 0 512 512"><path d="M256 32C114.6 32 0 125.1.0 240c0 49.6 21.4 95 57 130.7C44.5 421.1 2.7 466 2.2 466.5c-2.2 2.3-2.8 5.7-1.5 8.7S4.8 480 8 480c66.3.0 116-31.8 140.6-51.4 32.7 12.3 69 19.4 107.4 19.4 141.4.0 256-93.1 256-208S397.4 32 256 32z"/></svg></a></div><script type=module>
        (async () => {
            const supportSpeculationRules = HTMLScriptElement.supports && HTMLScriptElement.supports("speculationrules");
            if (!supportSpeculationRules) {
              await import("\/lib\/instant.page\/instantpage.min.js");
            }
        })();
    </script><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><script>window.config={"autocomplete.min.js":"/lib/autocomplete/autocomplete.min.js",comment:{giscus:{darkTheme:"dark",dataCategory:"Announcements",dataCategoryId:"DIC_kwDOM7VfQc4CjD-y",dataEmitMetadata:"0",dataInputPosition:"bottom",dataLang:"zh-CN",dataLoading:"lazy",dataMapping:"pathname",dataReactionsEnabled:"1",dataRepo:"Salvely/salvely.github.io",dataRepoId:"R_kgDOM7VfQQ",dataStrict:"0",lightTheme:"light"}},"fuse.min.js":"/lib/fuse/fuse.min.js",math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!0,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.1,type:"fuse",useExtendedSearch:!1},sharerjs:!0,table:{sort:!0}}</script><script src=/lib/tablesort/tablesort.min.js></script><script src=/lib/sharer/sharer.min.js></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/js/katex.min.js defer></script><script src=/js/theme.min.js defer></script><script src=/js/giscus.min.js defer></script><script type=speculationrules>
  {
    "prerender": [
      {
        "where": { "href_matches": "/*" },
        "eagerness": "moderate"
      }
    ]
  }
</script></body></html>